"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var https = require("https");

var http = require("http");

var request = require("request");

var querystring = require("query-string");

var URL = require("url").URL;

var isValidUrl = s => {
  if (!s || s === null) return false;

  try {
    if (s === "api.nexmo.com") return s;
    var o = new URL(s);
    return o.host;
  } catch (err) {
    return false;
  }
};

class HttpClient {
  constructor(options, credentials) {
    var hostOverride = isValidUrl(options.host);
    this.credentials = credentials;
    this.host = hostOverride ? hostOverride : "rest.nexmo.com";
    this.port = options.port || 443;
    this.https = options.https || https;
    this.http = options.http || http;
    this.headers = {
      "Content-Type": "application/x-www-form-urlencoded",
      Accept: "application/json"
    };
    this.logger = options.logger;
    this.timeout = options.timeout;
    this.requestLib = request;

    if (options.userAgent) {
      this.headers["User-Agent"] = options.userAgent;
    }
  }

  request(endpoint, method, callback) {
    var skipJsonParsing = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;
    var customResponseParser = arguments.length > 4 ? arguments[4] : undefined;

    if (typeof method === "function") {
      callback = method;
      endpoint.method = endpoint.method || "GET";
    } else if (typeof method !== "undefined") {
      endpoint.method = method;
    }

    var options = {
      host: endpoint.host ? endpoint.host : this.host,
      port: this.port,
      path: endpoint.path,
      method: endpoint.method,
      headers: Object.assign({}, this.headers, endpoint.headers)
    };

    if (this.timeout !== undefined) {
      options.timeout = this.timeout;
    } // Allow existing headers to be overridden
    // Allow new headers to be added


    if (endpoint.headers) {
      Object.keys(endpoint.headers).forEach(function (key) {
        options.headers[key] = endpoint.headers[key];
      });
    } // the output here can returnn one of two options:
    // - Using `sig` & `timestamp` in the JSON body
    // - Using `sig` & `timestamp` in the query string


    if (this.credentials.signatureSecret && this.credentials.signatureMethod) {
      // you must first add a timestamp
      var params;
      var splitPath;
      var path; // determine if the response should be querystring or JSON body

      if (!endpoint.body) {
        // this branch is for query string
        splitPath = options.path.split(/\?(.+)/);
        path = splitPath[0];
        params = querystring.parse(splitPath[1]);
      } else {
        // this section is for JSON body
        params = JSON.parse(endpoint.body);
      } // add timestamp if not already present


      if (!params.timestamp) {
        params.timestamp = (new Date().getTime() / 1000 | 0).toString();
      } // strip API Secret


      delete params.api_secret;
      var hash = this.credentials.generateSignature(params);
      params.sig = hash;

      if (!endpoint.body) {
        //this section is for querystring
        var query = ""; // rebuild query

        Object.keys(params).sort().forEach(key => {
          query += "&" + key + "=" + encodeURI(params[key]);
        }); // replace the first & with ?

        query = query.replace(/&/i, "?");
        options.path = "".concat(path).concat(query);
      } else {
        endpoint.body = JSON.stringify(params);
      }
    }

    this.logger.info("Request:", options, "\nBody:", endpoint.body);
    var request;

    if (options.port === 443) {
      request = this.https.request(options);
    } else {
      request = this.http.request(options);
    }

    request.end(endpoint.body); // Keep an array of String or Buffers,
    // depending on content type (binary or JSON) of response

    var responseData = [];
    request.on("response", response => {
      var isBinary = response.headers["content-type"] === "application/octet-stream";

      if (!isBinary) {
        response.setEncoding("utf8");
      }

      response.on("data", chunk => {
        responseData.push(chunk);
      });
      response.on("end", () => {
        this.logger.info("response ended:", response.statusCode);

        if (callback) {
          if (isBinary) {
            responseData = Buffer.concat(responseData);
          }

          this.__parseResponse(response, responseData, endpoint.method, callback, skipJsonParsing, customResponseParser);
        }
      });
      response.on("close", e => {
        if (e) {
          this.logger.error("problem with API request detailed stacktrace below ");
          this.logger.error(e);
          callback(e);
        }
      });
    });
    request.on("error", e => {
      this.logger.error("problem with API request detailed stacktrace below ");
      this.logger.error(e);
      callback(e);
    });
  }

  __parseResponse(httpResponse, data, method, callback, skipJsonParsing, customResponseParser) {
    var isArrayOrBuffer = data instanceof Array || data instanceof Buffer;

    if (!isArrayOrBuffer) {
      throw new Error("data should be of type Array or Buffer");
    }

    var status = httpResponse.statusCode;
    var headers = httpResponse.headers;
    var response = null;
    var error = null;

    try {
      if (status >= 500) {
        error = {
          message: "Server Error",
          statusCode: status
        };
      } else if (httpResponse.headers["content-type"] === "application/octet-stream") {
        response = data;
      } else if (status === 429) {
        // 429 does not return a parsable body
        if (!headers["retry-after"]) {
          // retry based on allowed per second
          var retryAfterMillis = method === "POST" ? 1000 / 2 : 1000 / 5;
          headers["retry-after"] = retryAfterMillis;
        }

        error = {
          body: data.join("")
        };
      } else if (status === 204) {
        response = null;
      } else if (status >= 400 || status < 200) {
        error = {
          body: JSON.parse(data.join("")),
          headers
        };
      } else if (method !== "DELETE") {
        if (!!skipJsonParsing) {
          response = data.join("");
        } else {
          response = JSON.parse(data.join(""));
        }
      } else {
        response = data;
      }
    } catch (parseError) {
      this.logger.error(parseError);
      this.logger.error("could not convert API response to JSON, above error is ignored and raw API response is returned to client");
      this.logger.error("Raw Error message from API ");
      this.logger.error("\"".concat(data, "\""));
      error = {
        status: status,
        message: "The API response could not be parsed.",
        body: data.join(""),
        parseError: parseError
      };
    }

    if (error) {
      error.statusCode = status;
      error.headers = headers;
    }

    if (typeof callback === "function") {
      if (typeof customResponseParser === "function") {
        // don't try to parse the response on errors
        if (response) {
          response = customResponseParser(response);
        }
      }

      callback(error, response);
    }
  }

  _addLimitedAccessMessageToErrors(callback, limitedAccessStatus) {
    return function (err, data) {
      if (err && err.status == limitedAccessStatus) {
        err._INFO_ = "This endpoint may need activating on your account. Please email support@nexmo.com for more information";
      }

      return callback(err, data);
    };
  }

  get(path, params, callback) {
    var useJwt = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;
    var useBasicAuth = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : false;

    if (!callback) {
      if (typeof params == "function") {
        callback = params;
        params = {};
      }
    }

    params = params || {};

    if (!useJwt && !useBasicAuth) {
      params["api_key"] = this.credentials.apiKey;
      params["api_secret"] = this.credentials.apiSecret;
    }

    path = path + "?" + querystring.stringify(params);
    var headers = {
      "Content-Type": "application/json"
    };

    if (useJwt) {
      headers["Authorization"] = "Bearer ".concat(this.credentials.generateJwt());
    }

    if (useBasicAuth) {
      headers["Authorization"] = "Basic ".concat(Buffer.from(this.credentials.apiKey + ":" + this.credentials.apiSecret).toString("base64"));
    }

    this.request({
      path: path,
      headers
    }, "GET", callback);
  }

  delete(path, callback, useJwt, useBasicAuth) {
    var params = {};

    if (!useJwt && !useBasicAuth) {
      params["api_key"] = this.credentials.apiKey;
      params["api_secret"] = this.credentials.apiSecret;
    }

    var headers = {};

    if (useBasicAuth) {
      headers["Authorization"] = "Basic ".concat(Buffer.from(this.credentials.apiKey + ":" + this.credentials.apiSecret).toString("base64"));
    }

    path = path + "?" + querystring.stringify(params);
    this.request({
      path: path,
      headers
    }, "DELETE", callback);
  }

  postFile(path, options, callback, useJwt) {
    var qs = {};

    if (!useJwt) {
      qs["api_key"] = this.credentials.apiKey;
      qs["api_secret"] = this.credentials.apiSecret;
    }

    if (Object.keys(qs).length) {
      var joinChar = "?";

      if (path.indexOf(joinChar) !== -1) {
        joinChar = "&";
      }

      path = path + joinChar + querystring.stringify(qs);
    }

    var file = options.file;
    delete options.file; // We don't send this as metadata

    var formData = {};

    if (file) {
      formData["filedata"] = {
        value: file,
        options: {
          filename: options.filename || null
        }
      };
    }

    if (options.info) {
      formData.info = JSON.stringify(options.info);
    }

    if (options.url) {
      formData.url = options.url;
    }

    var protocol = this.port === 443 ? "https://" : "http://";
    this.requestLib.post({
      url: protocol + this.host + path,
      formData: formData,
      headers: {
        Authorization: "Bearer ".concat(this.credentials.generateJwt())
      }
    }, callback);
  }

  post(path, params, callback, useJwt) {
    var qs = {};

    if (!useJwt) {
      qs["api_key"] = this.credentials.apiKey;
      qs["api_secret"] = this.credentials.apiSecret;
    }

    var joinChar = "?";

    if (path.indexOf(joinChar) !== -1) {
      joinChar = "&";
    }

    path = path + joinChar + querystring.stringify(qs);
    this.request({
      path: path,
      body: querystring.stringify(params)
    }, "POST", callback);
  }

  postJson(path, params, callback, useJwt, useBasicAuth) {
    var qs = {};

    if (!useJwt && !useBasicAuth) {
      qs["api_key"] = this.credentials.apiKey;
      qs["api_secret"] = this.credentials.apiSecret;
    }

    var joinChar = "?";

    if (path.indexOf(joinChar) !== -1) {
      joinChar = "&";
    }

    path = path + joinChar + querystring.stringify(qs);
    var headers = {
      "Content-Type": "application/json"
    };

    if (useBasicAuth) {
      headers["Authorization"] = "Basic ".concat(Buffer.from(this.credentials.apiKey + ":" + this.credentials.apiSecret).toString("base64"));
    }

    this.request({
      path: path,
      body: JSON.stringify(params),
      headers
    }, "POST", callback);
  }

  postUseQueryString(path, params, callback, useJwt) {
    params = params || {};

    if (!useJwt) {
      params["api_key"] = this.credentials.apiKey;
      params["api_secret"] = this.credentials.apiSecret;
    }

    path = path + "?" + querystring.stringify(params);
    this.request({
      path: path
    }, "POST", callback);
  }

}

var _default = HttpClient;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9IdHRwQ2xpZW50LmpzIl0sIm5hbWVzIjpbImh0dHBzIiwicmVxdWlyZSIsImh0dHAiLCJyZXF1ZXN0IiwicXVlcnlzdHJpbmciLCJVUkwiLCJpc1ZhbGlkVXJsIiwicyIsIm8iLCJob3N0IiwiZXJyIiwiSHR0cENsaWVudCIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsImNyZWRlbnRpYWxzIiwiaG9zdE92ZXJyaWRlIiwicG9ydCIsImhlYWRlcnMiLCJBY2NlcHQiLCJsb2dnZXIiLCJ0aW1lb3V0IiwicmVxdWVzdExpYiIsInVzZXJBZ2VudCIsImVuZHBvaW50IiwibWV0aG9kIiwiY2FsbGJhY2siLCJza2lwSnNvblBhcnNpbmciLCJjdXN0b21SZXNwb25zZVBhcnNlciIsInBhdGgiLCJPYmplY3QiLCJhc3NpZ24iLCJ1bmRlZmluZWQiLCJrZXlzIiwiZm9yRWFjaCIsImtleSIsInNpZ25hdHVyZVNlY3JldCIsInNpZ25hdHVyZU1ldGhvZCIsInBhcmFtcyIsInNwbGl0UGF0aCIsImJvZHkiLCJzcGxpdCIsInBhcnNlIiwiSlNPTiIsInRpbWVzdGFtcCIsIkRhdGUiLCJnZXRUaW1lIiwidG9TdHJpbmciLCJhcGlfc2VjcmV0IiwiaGFzaCIsImdlbmVyYXRlU2lnbmF0dXJlIiwic2lnIiwicXVlcnkiLCJzb3J0IiwiZW5jb2RlVVJJIiwicmVwbGFjZSIsInN0cmluZ2lmeSIsImluZm8iLCJlbmQiLCJyZXNwb25zZURhdGEiLCJvbiIsInJlc3BvbnNlIiwiaXNCaW5hcnkiLCJzZXRFbmNvZGluZyIsImNodW5rIiwicHVzaCIsInN0YXR1c0NvZGUiLCJCdWZmZXIiLCJjb25jYXQiLCJfX3BhcnNlUmVzcG9uc2UiLCJlIiwiZXJyb3IiLCJodHRwUmVzcG9uc2UiLCJkYXRhIiwiaXNBcnJheU9yQnVmZmVyIiwiQXJyYXkiLCJFcnJvciIsInN0YXR1cyIsIm1lc3NhZ2UiLCJyZXRyeUFmdGVyTWlsbGlzIiwiam9pbiIsInBhcnNlRXJyb3IiLCJfYWRkTGltaXRlZEFjY2Vzc01lc3NhZ2VUb0Vycm9ycyIsImxpbWl0ZWRBY2Nlc3NTdGF0dXMiLCJfSU5GT18iLCJnZXQiLCJ1c2VKd3QiLCJ1c2VCYXNpY0F1dGgiLCJhcGlLZXkiLCJhcGlTZWNyZXQiLCJnZW5lcmF0ZUp3dCIsImZyb20iLCJkZWxldGUiLCJwb3N0RmlsZSIsInFzIiwibGVuZ3RoIiwiam9pbkNoYXIiLCJpbmRleE9mIiwiZmlsZSIsImZvcm1EYXRhIiwidmFsdWUiLCJmaWxlbmFtZSIsInVybCIsInByb3RvY29sIiwicG9zdCIsIkF1dGhvcml6YXRpb24iLCJwb3N0SnNvbiIsInBvc3RVc2VRdWVyeVN0cmluZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBLElBQUlBLEtBQUssR0FBR0MsT0FBTyxDQUFDLE9BQUQsQ0FBbkI7O0FBQ0EsSUFBSUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsTUFBRCxDQUFsQjs7QUFDQSxJQUFJRSxPQUFPLEdBQUdGLE9BQU8sQ0FBQyxTQUFELENBQXJCOztBQUNBLElBQUlHLFdBQVcsR0FBR0gsT0FBTyxDQUFDLGNBQUQsQ0FBekI7O0FBQ0EsSUFBSUksR0FBRyxHQUFHSixPQUFPLENBQUMsS0FBRCxDQUFQLENBQWVJLEdBQXpCOztBQUVBLElBQU1DLFVBQVUsR0FBSUMsQ0FBRCxJQUFPO0FBQ3hCLE1BQUksQ0FBQ0EsQ0FBRCxJQUFNQSxDQUFDLEtBQUssSUFBaEIsRUFBc0IsT0FBTyxLQUFQOztBQUV0QixNQUFJO0FBQ0YsUUFBSUEsQ0FBQyxLQUFLLGVBQVYsRUFBMkIsT0FBT0EsQ0FBUDtBQUMzQixRQUFJQyxDQUFDLEdBQUcsSUFBSUgsR0FBSixDQUFRRSxDQUFSLENBQVI7QUFDQSxXQUFPQyxDQUFDLENBQUNDLElBQVQ7QUFDRCxHQUpELENBSUUsT0FBT0MsR0FBUCxFQUFZO0FBQ1osV0FBTyxLQUFQO0FBQ0Q7QUFDRixDQVZEOztBQVlBLE1BQU1DLFVBQU4sQ0FBaUI7QUFDZkMsRUFBQUEsV0FBVyxDQUFDQyxPQUFELEVBQVVDLFdBQVYsRUFBdUI7QUFDaEMsUUFBSUMsWUFBWSxHQUFHVCxVQUFVLENBQUNPLE9BQU8sQ0FBQ0osSUFBVCxDQUE3QjtBQUNBLFNBQUtLLFdBQUwsR0FBbUJBLFdBQW5CO0FBQ0EsU0FBS0wsSUFBTCxHQUFZTSxZQUFZLEdBQUdBLFlBQUgsbUJBQXhCO0FBQ0EsU0FBS0MsSUFBTCxHQUFZSCxPQUFPLENBQUNHLElBQVIsSUFBZ0IsR0FBNUI7QUFDQSxTQUFLaEIsS0FBTCxHQUFhYSxPQUFPLENBQUNiLEtBQVIsSUFBaUJBLEtBQTlCO0FBQ0EsU0FBS0UsSUFBTCxHQUFZVyxPQUFPLENBQUNYLElBQVIsSUFBZ0JBLElBQTVCO0FBQ0EsU0FBS2UsT0FBTCxHQUFlO0FBQ2Isc0JBQWdCLG1DQURIO0FBRWJDLE1BQUFBLE1BQU0sRUFBRTtBQUZLLEtBQWY7QUFJQSxTQUFLQyxNQUFMLEdBQWNOLE9BQU8sQ0FBQ00sTUFBdEI7QUFDQSxTQUFLQyxPQUFMLEdBQWVQLE9BQU8sQ0FBQ08sT0FBdkI7QUFDQSxTQUFLQyxVQUFMLEdBQWtCbEIsT0FBbEI7O0FBRUEsUUFBSVUsT0FBTyxDQUFDUyxTQUFaLEVBQXVCO0FBQ3JCLFdBQUtMLE9BQUwsQ0FBYSxZQUFiLElBQTZCSixPQUFPLENBQUNTLFNBQXJDO0FBQ0Q7QUFDRjs7QUFFRG5CLEVBQUFBLE9BQU8sQ0FDTG9CLFFBREssRUFFTEMsTUFGSyxFQUdMQyxRQUhLLEVBTUw7QUFBQSxRQUZBQyxlQUVBLHVFQUZrQixLQUVsQjtBQUFBLFFBREFDLG9CQUNBOztBQUNBLFFBQUksT0FBT0gsTUFBUCxLQUFrQixVQUF0QixFQUFrQztBQUNoQ0MsTUFBQUEsUUFBUSxHQUFHRCxNQUFYO0FBQ0FELE1BQUFBLFFBQVEsQ0FBQ0MsTUFBVCxHQUFrQkQsUUFBUSxDQUFDQyxNQUFULElBQW1CLEtBQXJDO0FBQ0QsS0FIRCxNQUdPLElBQUksT0FBT0EsTUFBUCxLQUFrQixXQUF0QixFQUFtQztBQUN4Q0QsTUFBQUEsUUFBUSxDQUFDQyxNQUFULEdBQWtCQSxNQUFsQjtBQUNEOztBQUVELFFBQUlYLE9BQU8sR0FBRztBQUNaSixNQUFBQSxJQUFJLEVBQUVjLFFBQVEsQ0FBQ2QsSUFBVCxHQUFnQmMsUUFBUSxDQUFDZCxJQUF6QixHQUFnQyxLQUFLQSxJQUQvQjtBQUVaTyxNQUFBQSxJQUFJLEVBQUUsS0FBS0EsSUFGQztBQUdaWSxNQUFBQSxJQUFJLEVBQUVMLFFBQVEsQ0FBQ0ssSUFISDtBQUlaSixNQUFBQSxNQUFNLEVBQUVELFFBQVEsQ0FBQ0MsTUFKTDtBQUtaUCxNQUFBQSxPQUFPLEVBQUVZLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLEVBQWQsRUFBa0IsS0FBS2IsT0FBdkIsRUFBZ0NNLFFBQVEsQ0FBQ04sT0FBekM7QUFMRyxLQUFkOztBQVFBLFFBQUksS0FBS0csT0FBTCxLQUFpQlcsU0FBckIsRUFBZ0M7QUFDOUJsQixNQUFBQSxPQUFPLENBQUNPLE9BQVIsR0FBa0IsS0FBS0EsT0FBdkI7QUFDRCxLQWxCRCxDQW9CQTtBQUNBOzs7QUFDQSxRQUFJRyxRQUFRLENBQUNOLE9BQWIsRUFBc0I7QUFDcEJZLE1BQUFBLE1BQU0sQ0FBQ0csSUFBUCxDQUFZVCxRQUFRLENBQUNOLE9BQXJCLEVBQThCZ0IsT0FBOUIsQ0FBc0MsVUFBVUMsR0FBVixFQUFlO0FBQ25EckIsUUFBQUEsT0FBTyxDQUFDSSxPQUFSLENBQWdCaUIsR0FBaEIsSUFBdUJYLFFBQVEsQ0FBQ04sT0FBVCxDQUFpQmlCLEdBQWpCLENBQXZCO0FBQ0QsT0FGRDtBQUdELEtBMUJELENBNEJBO0FBQ0E7QUFDQTs7O0FBRUEsUUFBSSxLQUFLcEIsV0FBTCxDQUFpQnFCLGVBQWpCLElBQW9DLEtBQUtyQixXQUFMLENBQWlCc0IsZUFBekQsRUFBMEU7QUFDeEU7QUFDQSxVQUFJQyxNQUFKO0FBQ0EsVUFBSUMsU0FBSjtBQUNBLFVBQUlWLElBQUosQ0FKd0UsQ0FNeEU7O0FBQ0EsVUFBSSxDQUFDTCxRQUFRLENBQUNnQixJQUFkLEVBQW9CO0FBQ2xCO0FBQ0FELFFBQUFBLFNBQVMsR0FBR3pCLE9BQU8sQ0FBQ2UsSUFBUixDQUFhWSxLQUFiLENBQW1CLFFBQW5CLENBQVo7QUFDQVosUUFBQUEsSUFBSSxHQUFHVSxTQUFTLENBQUMsQ0FBRCxDQUFoQjtBQUVBRCxRQUFBQSxNQUFNLEdBQUdqQyxXQUFXLENBQUNxQyxLQUFaLENBQWtCSCxTQUFTLENBQUMsQ0FBRCxDQUEzQixDQUFUO0FBQ0QsT0FORCxNQU1PO0FBQ0w7QUFDQUQsUUFBQUEsTUFBTSxHQUFHSyxJQUFJLENBQUNELEtBQUwsQ0FBV2xCLFFBQVEsQ0FBQ2dCLElBQXBCLENBQVQ7QUFDRCxPQWhCdUUsQ0FrQnhFOzs7QUFDQSxVQUFJLENBQUNGLE1BQU0sQ0FBQ00sU0FBWixFQUF1QjtBQUNyQk4sUUFBQUEsTUFBTSxDQUFDTSxTQUFQLEdBQW1CLENBQUUsSUFBSUMsSUFBSixHQUFXQyxPQUFYLEtBQXVCLElBQXhCLEdBQWdDLENBQWpDLEVBQW9DQyxRQUFwQyxFQUFuQjtBQUNELE9BckJ1RSxDQXVCeEU7OztBQUNBLGFBQU9ULE1BQU0sQ0FBQ1UsVUFBZDtBQUVBLFVBQUlDLElBQUksR0FBRyxLQUFLbEMsV0FBTCxDQUFpQm1DLGlCQUFqQixDQUFtQ1osTUFBbkMsQ0FBWDtBQUNBQSxNQUFBQSxNQUFNLENBQUNhLEdBQVAsR0FBYUYsSUFBYjs7QUFFQSxVQUFJLENBQUN6QixRQUFRLENBQUNnQixJQUFkLEVBQW9CO0FBQ2xCO0FBQ0EsWUFBSVksS0FBSyxHQUFHLEVBQVosQ0FGa0IsQ0FJbEI7O0FBQ0F0QixRQUFBQSxNQUFNLENBQUNHLElBQVAsQ0FBWUssTUFBWixFQUNHZSxJQURILEdBRUduQixPQUZILENBRVlDLEdBQUQsSUFBUztBQUNoQmlCLFVBQUFBLEtBQUssSUFBSSxNQUFNakIsR0FBTixHQUFZLEdBQVosR0FBa0JtQixTQUFTLENBQUNoQixNQUFNLENBQUNILEdBQUQsQ0FBUCxDQUFwQztBQUNELFNBSkgsRUFMa0IsQ0FXbEI7O0FBQ0FpQixRQUFBQSxLQUFLLEdBQUdBLEtBQUssQ0FBQ0csT0FBTixDQUFjLElBQWQsRUFBb0IsR0FBcEIsQ0FBUjtBQUVBekMsUUFBQUEsT0FBTyxDQUFDZSxJQUFSLGFBQWtCQSxJQUFsQixTQUF5QnVCLEtBQXpCO0FBQ0QsT0FmRCxNQWVPO0FBQ0w1QixRQUFBQSxRQUFRLENBQUNnQixJQUFULEdBQWdCRyxJQUFJLENBQUNhLFNBQUwsQ0FBZWxCLE1BQWYsQ0FBaEI7QUFDRDtBQUNGOztBQUVELFNBQUtsQixNQUFMLENBQVlxQyxJQUFaLENBQWlCLFVBQWpCLEVBQTZCM0MsT0FBN0IsRUFBc0MsU0FBdEMsRUFBaURVLFFBQVEsQ0FBQ2dCLElBQTFEO0FBRUEsUUFBSXBDLE9BQUo7O0FBRUEsUUFBSVUsT0FBTyxDQUFDRyxJQUFSLEtBQWlCLEdBQXJCLEVBQTBCO0FBQ3hCYixNQUFBQSxPQUFPLEdBQUcsS0FBS0gsS0FBTCxDQUFXRyxPQUFYLENBQW1CVSxPQUFuQixDQUFWO0FBQ0QsS0FGRCxNQUVPO0FBQ0xWLE1BQUFBLE9BQU8sR0FBRyxLQUFLRCxJQUFMLENBQVVDLE9BQVYsQ0FBa0JVLE9BQWxCLENBQVY7QUFDRDs7QUFFRFYsSUFBQUEsT0FBTyxDQUFDc0QsR0FBUixDQUFZbEMsUUFBUSxDQUFDZ0IsSUFBckIsRUEzRkEsQ0E2RkE7QUFDQTs7QUFDQSxRQUFJbUIsWUFBWSxHQUFHLEVBQW5CO0FBRUF2RCxJQUFBQSxPQUFPLENBQUN3RCxFQUFSLENBQVcsVUFBWCxFQUF3QkMsUUFBRCxJQUFjO0FBQ25DLFVBQUlDLFFBQVEsR0FDVkQsUUFBUSxDQUFDM0MsT0FBVCxDQUFpQixjQUFqQixNQUFxQywwQkFEdkM7O0FBRUEsVUFBSSxDQUFDNEMsUUFBTCxFQUFlO0FBQ2JELFFBQUFBLFFBQVEsQ0FBQ0UsV0FBVCxDQUFxQixNQUFyQjtBQUNEOztBQUVERixNQUFBQSxRQUFRLENBQUNELEVBQVQsQ0FBWSxNQUFaLEVBQXFCSSxLQUFELElBQVc7QUFDN0JMLFFBQUFBLFlBQVksQ0FBQ00sSUFBYixDQUFrQkQsS0FBbEI7QUFDRCxPQUZEO0FBSUFILE1BQUFBLFFBQVEsQ0FBQ0QsRUFBVCxDQUFZLEtBQVosRUFBbUIsTUFBTTtBQUN2QixhQUFLeEMsTUFBTCxDQUFZcUMsSUFBWixDQUFpQixpQkFBakIsRUFBb0NJLFFBQVEsQ0FBQ0ssVUFBN0M7O0FBQ0EsWUFBSXhDLFFBQUosRUFBYztBQUNaLGNBQUlvQyxRQUFKLEVBQWM7QUFDWkgsWUFBQUEsWUFBWSxHQUFHUSxNQUFNLENBQUNDLE1BQVAsQ0FBY1QsWUFBZCxDQUFmO0FBQ0Q7O0FBRUQsZUFBS1UsZUFBTCxDQUNFUixRQURGLEVBRUVGLFlBRkYsRUFHRW5DLFFBQVEsQ0FBQ0MsTUFIWCxFQUlFQyxRQUpGLEVBS0VDLGVBTEYsRUFNRUMsb0JBTkY7QUFRRDtBQUNGLE9BaEJEO0FBaUJBaUMsTUFBQUEsUUFBUSxDQUFDRCxFQUFULENBQVksT0FBWixFQUFzQlUsQ0FBRCxJQUFPO0FBQzFCLFlBQUlBLENBQUosRUFBTztBQUNMLGVBQUtsRCxNQUFMLENBQVltRCxLQUFaLENBQ0UscURBREY7QUFHQSxlQUFLbkQsTUFBTCxDQUFZbUQsS0FBWixDQUFrQkQsQ0FBbEI7QUFDQTVDLFVBQUFBLFFBQVEsQ0FBQzRDLENBQUQsQ0FBUjtBQUNEO0FBQ0YsT0FSRDtBQVNELEtBckNEO0FBc0NBbEUsSUFBQUEsT0FBTyxDQUFDd0QsRUFBUixDQUFXLE9BQVgsRUFBcUJVLENBQUQsSUFBTztBQUN6QixXQUFLbEQsTUFBTCxDQUFZbUQsS0FBWixDQUFrQixxREFBbEI7QUFDQSxXQUFLbkQsTUFBTCxDQUFZbUQsS0FBWixDQUFrQkQsQ0FBbEI7QUFDQTVDLE1BQUFBLFFBQVEsQ0FBQzRDLENBQUQsQ0FBUjtBQUNELEtBSkQ7QUFLRDs7QUFFREQsRUFBQUEsZUFBZSxDQUNiRyxZQURhLEVBRWJDLElBRmEsRUFHYmhELE1BSGEsRUFJYkMsUUFKYSxFQUtiQyxlQUxhLEVBTWJDLG9CQU5hLEVBT2I7QUFDQSxRQUFNOEMsZUFBZSxHQUFHRCxJQUFJLFlBQVlFLEtBQWhCLElBQXlCRixJQUFJLFlBQVlOLE1BQWpFOztBQUNBLFFBQUksQ0FBQ08sZUFBTCxFQUFzQjtBQUNwQixZQUFNLElBQUlFLEtBQUosQ0FBVSx3Q0FBVixDQUFOO0FBQ0Q7O0FBRUQsUUFBTUMsTUFBTSxHQUFHTCxZQUFZLENBQUNOLFVBQTVCO0FBQ0EsUUFBTWhELE9BQU8sR0FBR3NELFlBQVksQ0FBQ3RELE9BQTdCO0FBRUEsUUFBSTJDLFFBQVEsR0FBRyxJQUFmO0FBQ0EsUUFBSVUsS0FBSyxHQUFHLElBQVo7O0FBRUEsUUFBSTtBQUNGLFVBQUlNLE1BQU0sSUFBSSxHQUFkLEVBQW1CO0FBQ2pCTixRQUFBQSxLQUFLLEdBQUc7QUFDTk8sVUFBQUEsT0FBTyxFQUFFLGNBREg7QUFFTlosVUFBQUEsVUFBVSxFQUFFVztBQUZOLFNBQVI7QUFJRCxPQUxELE1BS08sSUFDTEwsWUFBWSxDQUFDdEQsT0FBYixDQUFxQixjQUFyQixNQUF5QywwQkFEcEMsRUFFTDtBQUNBMkMsUUFBQUEsUUFBUSxHQUFHWSxJQUFYO0FBQ0QsT0FKTSxNQUlBLElBQUlJLE1BQU0sS0FBSyxHQUFmLEVBQW9CO0FBQ3pCO0FBQ0EsWUFBSSxDQUFDM0QsT0FBTyxDQUFDLGFBQUQsQ0FBWixFQUE2QjtBQUMzQjtBQUNBLGNBQU02RCxnQkFBZ0IsR0FBR3RELE1BQU0sS0FBSyxNQUFYLEdBQW9CLE9BQU8sQ0FBM0IsR0FBK0IsT0FBTyxDQUEvRDtBQUNBUCxVQUFBQSxPQUFPLENBQUMsYUFBRCxDQUFQLEdBQXlCNkQsZ0JBQXpCO0FBQ0Q7O0FBQ0RSLFFBQUFBLEtBQUssR0FBRztBQUNOL0IsVUFBQUEsSUFBSSxFQUFFaUMsSUFBSSxDQUFDTyxJQUFMLENBQVUsRUFBVjtBQURBLFNBQVI7QUFHRCxPQVZNLE1BVUEsSUFBSUgsTUFBTSxLQUFLLEdBQWYsRUFBb0I7QUFDekJoQixRQUFBQSxRQUFRLEdBQUcsSUFBWDtBQUNELE9BRk0sTUFFQSxJQUFJZ0IsTUFBTSxJQUFJLEdBQVYsSUFBaUJBLE1BQU0sR0FBRyxHQUE5QixFQUFtQztBQUN4Q04sUUFBQUEsS0FBSyxHQUFHO0FBQ04vQixVQUFBQSxJQUFJLEVBQUVHLElBQUksQ0FBQ0QsS0FBTCxDQUFXK0IsSUFBSSxDQUFDTyxJQUFMLENBQVUsRUFBVixDQUFYLENBREE7QUFFTjlELFVBQUFBO0FBRk0sU0FBUjtBQUlELE9BTE0sTUFLQSxJQUFJTyxNQUFNLEtBQUssUUFBZixFQUF5QjtBQUM5QixZQUFJLENBQUMsQ0FBQ0UsZUFBTixFQUF1QjtBQUNyQmtDLFVBQUFBLFFBQVEsR0FBR1ksSUFBSSxDQUFDTyxJQUFMLENBQVUsRUFBVixDQUFYO0FBQ0QsU0FGRCxNQUVPO0FBQ0xuQixVQUFBQSxRQUFRLEdBQUdsQixJQUFJLENBQUNELEtBQUwsQ0FBVytCLElBQUksQ0FBQ08sSUFBTCxDQUFVLEVBQVYsQ0FBWCxDQUFYO0FBQ0Q7QUFDRixPQU5NLE1BTUE7QUFDTG5CLFFBQUFBLFFBQVEsR0FBR1ksSUFBWDtBQUNEO0FBQ0YsS0FwQ0QsQ0FvQ0UsT0FBT1EsVUFBUCxFQUFtQjtBQUNuQixXQUFLN0QsTUFBTCxDQUFZbUQsS0FBWixDQUFrQlUsVUFBbEI7QUFDQSxXQUFLN0QsTUFBTCxDQUFZbUQsS0FBWixDQUNFLDJHQURGO0FBR0EsV0FBS25ELE1BQUwsQ0FBWW1ELEtBQVosQ0FBa0IsNkJBQWxCO0FBQ0EsV0FBS25ELE1BQUwsQ0FBWW1ELEtBQVosYUFBc0JFLElBQXRCO0FBRUFGLE1BQUFBLEtBQUssR0FBRztBQUNOTSxRQUFBQSxNQUFNLEVBQUVBLE1BREY7QUFFTkMsUUFBQUEsT0FBTyxFQUFFLHVDQUZIO0FBR050QyxRQUFBQSxJQUFJLEVBQUVpQyxJQUFJLENBQUNPLElBQUwsQ0FBVSxFQUFWLENBSEE7QUFJTkMsUUFBQUEsVUFBVSxFQUFFQTtBQUpOLE9BQVI7QUFNRDs7QUFFRCxRQUFJVixLQUFKLEVBQVc7QUFDVEEsTUFBQUEsS0FBSyxDQUFDTCxVQUFOLEdBQW1CVyxNQUFuQjtBQUNBTixNQUFBQSxLQUFLLENBQUNyRCxPQUFOLEdBQWdCQSxPQUFoQjtBQUNEOztBQUVELFFBQUksT0FBT1EsUUFBUCxLQUFvQixVQUF4QixFQUFvQztBQUNsQyxVQUFJLE9BQU9FLG9CQUFQLEtBQWdDLFVBQXBDLEVBQWdEO0FBQzlDO0FBQ0EsWUFBSWlDLFFBQUosRUFBYztBQUNaQSxVQUFBQSxRQUFRLEdBQUdqQyxvQkFBb0IsQ0FBQ2lDLFFBQUQsQ0FBL0I7QUFDRDtBQUNGOztBQUNEbkMsTUFBQUEsUUFBUSxDQUFDNkMsS0FBRCxFQUFRVixRQUFSLENBQVI7QUFDRDtBQUNGOztBQUVEcUIsRUFBQUEsZ0NBQWdDLENBQUN4RCxRQUFELEVBQVd5RCxtQkFBWCxFQUFnQztBQUM5RCxXQUFPLFVBQVV4RSxHQUFWLEVBQWU4RCxJQUFmLEVBQXFCO0FBQzFCLFVBQUk5RCxHQUFHLElBQUlBLEdBQUcsQ0FBQ2tFLE1BQUosSUFBY00sbUJBQXpCLEVBQThDO0FBQzVDeEUsUUFBQUEsR0FBRyxDQUFDeUUsTUFBSixHQUNFLHdHQURGO0FBRUQ7O0FBRUQsYUFBTzFELFFBQVEsQ0FBQ2YsR0FBRCxFQUFNOEQsSUFBTixDQUFmO0FBQ0QsS0FQRDtBQVFEOztBQUVEWSxFQUFBQSxHQUFHLENBQUN4RCxJQUFELEVBQU9TLE1BQVAsRUFBZVosUUFBZixFQUErRDtBQUFBLFFBQXRDNEQsTUFBc0MsdUVBQTdCLEtBQTZCO0FBQUEsUUFBdEJDLFlBQXNCLHVFQUFQLEtBQU87O0FBQ2hFLFFBQUksQ0FBQzdELFFBQUwsRUFBZTtBQUNiLFVBQUksT0FBT1ksTUFBUCxJQUFpQixVQUFyQixFQUFpQztBQUMvQlosUUFBQUEsUUFBUSxHQUFHWSxNQUFYO0FBQ0FBLFFBQUFBLE1BQU0sR0FBRyxFQUFUO0FBQ0Q7QUFDRjs7QUFFREEsSUFBQUEsTUFBTSxHQUFHQSxNQUFNLElBQUksRUFBbkI7O0FBQ0EsUUFBSSxDQUFDZ0QsTUFBRCxJQUFXLENBQUNDLFlBQWhCLEVBQThCO0FBQzVCakQsTUFBQUEsTUFBTSxDQUFDLFNBQUQsQ0FBTixHQUFvQixLQUFLdkIsV0FBTCxDQUFpQnlFLE1BQXJDO0FBQ0FsRCxNQUFBQSxNQUFNLENBQUMsWUFBRCxDQUFOLEdBQXVCLEtBQUt2QixXQUFMLENBQWlCMEUsU0FBeEM7QUFDRDs7QUFFRDVELElBQUFBLElBQUksR0FBR0EsSUFBSSxHQUFHLEdBQVAsR0FBYXhCLFdBQVcsQ0FBQ21ELFNBQVosQ0FBc0JsQixNQUF0QixDQUFwQjtBQUVBLFFBQU1wQixPQUFPLEdBQUc7QUFDZCxzQkFBZ0I7QUFERixLQUFoQjs7QUFHQSxRQUFJb0UsTUFBSixFQUFZO0FBQ1ZwRSxNQUFBQSxPQUFPLENBQUMsZUFBRCxDQUFQLG9CQUFxQyxLQUFLSCxXQUFMLENBQWlCMkUsV0FBakIsRUFBckM7QUFDRDs7QUFDRCxRQUFJSCxZQUFKLEVBQWtCO0FBQ2hCckUsTUFBQUEsT0FBTyxDQUFDLGVBQUQsQ0FBUCxtQkFBb0NpRCxNQUFNLENBQUN3QixJQUFQLENBQ2xDLEtBQUs1RSxXQUFMLENBQWlCeUUsTUFBakIsR0FBMEIsR0FBMUIsR0FBZ0MsS0FBS3pFLFdBQUwsQ0FBaUIwRSxTQURmLEVBRWxDMUMsUUFGa0MsQ0FFekIsUUFGeUIsQ0FBcEM7QUFHRDs7QUFFRCxTQUFLM0MsT0FBTCxDQUNFO0FBQ0V5QixNQUFBQSxJQUFJLEVBQUVBLElBRFI7QUFFRVgsTUFBQUE7QUFGRixLQURGLEVBS0UsS0FMRixFQU1FUSxRQU5GO0FBUUQ7O0FBRURrRSxFQUFBQSxNQUFNLENBQUMvRCxJQUFELEVBQU9ILFFBQVAsRUFBaUI0RCxNQUFqQixFQUF5QkMsWUFBekIsRUFBdUM7QUFDM0MsUUFBSWpELE1BQU0sR0FBRyxFQUFiOztBQUNBLFFBQUksQ0FBQ2dELE1BQUQsSUFBVyxDQUFDQyxZQUFoQixFQUE4QjtBQUM1QmpELE1BQUFBLE1BQU0sQ0FBQyxTQUFELENBQU4sR0FBb0IsS0FBS3ZCLFdBQUwsQ0FBaUJ5RSxNQUFyQztBQUNBbEQsTUFBQUEsTUFBTSxDQUFDLFlBQUQsQ0FBTixHQUF1QixLQUFLdkIsV0FBTCxDQUFpQjBFLFNBQXhDO0FBQ0Q7O0FBRUQsUUFBSXZFLE9BQU8sR0FBRyxFQUFkOztBQUVBLFFBQUlxRSxZQUFKLEVBQWtCO0FBQ2hCckUsTUFBQUEsT0FBTyxDQUFDLGVBQUQsQ0FBUCxtQkFBb0NpRCxNQUFNLENBQUN3QixJQUFQLENBQ2xDLEtBQUs1RSxXQUFMLENBQWlCeUUsTUFBakIsR0FBMEIsR0FBMUIsR0FBZ0MsS0FBS3pFLFdBQUwsQ0FBaUIwRSxTQURmLEVBRWxDMUMsUUFGa0MsQ0FFekIsUUFGeUIsQ0FBcEM7QUFHRDs7QUFDRGxCLElBQUFBLElBQUksR0FBR0EsSUFBSSxHQUFHLEdBQVAsR0FBYXhCLFdBQVcsQ0FBQ21ELFNBQVosQ0FBc0JsQixNQUF0QixDQUFwQjtBQUVBLFNBQUtsQyxPQUFMLENBQ0U7QUFDRXlCLE1BQUFBLElBQUksRUFBRUEsSUFEUjtBQUVFWCxNQUFBQTtBQUZGLEtBREYsRUFLRSxRQUxGLEVBTUVRLFFBTkY7QUFRRDs7QUFFRG1FLEVBQUFBLFFBQVEsQ0FBQ2hFLElBQUQsRUFBT2YsT0FBUCxFQUFnQlksUUFBaEIsRUFBMEI0RCxNQUExQixFQUFrQztBQUN4QyxRQUFJUSxFQUFFLEdBQUcsRUFBVDs7QUFDQSxRQUFJLENBQUNSLE1BQUwsRUFBYTtBQUNYUSxNQUFBQSxFQUFFLENBQUMsU0FBRCxDQUFGLEdBQWdCLEtBQUsvRSxXQUFMLENBQWlCeUUsTUFBakM7QUFDQU0sTUFBQUEsRUFBRSxDQUFDLFlBQUQsQ0FBRixHQUFtQixLQUFLL0UsV0FBTCxDQUFpQjBFLFNBQXBDO0FBQ0Q7O0FBRUQsUUFBSTNELE1BQU0sQ0FBQ0csSUFBUCxDQUFZNkQsRUFBWixFQUFnQkMsTUFBcEIsRUFBNEI7QUFDMUIsVUFBSUMsUUFBUSxHQUFHLEdBQWY7O0FBQ0EsVUFBSW5FLElBQUksQ0FBQ29FLE9BQUwsQ0FBYUQsUUFBYixNQUEyQixDQUFDLENBQWhDLEVBQW1DO0FBQ2pDQSxRQUFBQSxRQUFRLEdBQUcsR0FBWDtBQUNEOztBQUNEbkUsTUFBQUEsSUFBSSxHQUFHQSxJQUFJLEdBQUdtRSxRQUFQLEdBQWtCM0YsV0FBVyxDQUFDbUQsU0FBWixDQUFzQnNDLEVBQXRCLENBQXpCO0FBQ0Q7O0FBRUQsUUFBTUksSUFBSSxHQUFHcEYsT0FBTyxDQUFDb0YsSUFBckI7QUFDQSxXQUFPcEYsT0FBTyxDQUFDb0YsSUFBZixDQWhCd0MsQ0FnQm5COztBQUVyQixRQUFNQyxRQUFRLEdBQUcsRUFBakI7O0FBRUEsUUFBSUQsSUFBSixFQUFVO0FBQ1JDLE1BQUFBLFFBQVEsQ0FBQyxVQUFELENBQVIsR0FBdUI7QUFDckJDLFFBQUFBLEtBQUssRUFBRUYsSUFEYztBQUVyQnBGLFFBQUFBLE9BQU8sRUFBRTtBQUNQdUYsVUFBQUEsUUFBUSxFQUFFdkYsT0FBTyxDQUFDdUYsUUFBUixJQUFvQjtBQUR2QjtBQUZZLE9BQXZCO0FBTUQ7O0FBRUQsUUFBSXZGLE9BQU8sQ0FBQzJDLElBQVosRUFBa0I7QUFDaEIwQyxNQUFBQSxRQUFRLENBQUMxQyxJQUFULEdBQWdCZCxJQUFJLENBQUNhLFNBQUwsQ0FBZTFDLE9BQU8sQ0FBQzJDLElBQXZCLENBQWhCO0FBQ0Q7O0FBRUQsUUFBSTNDLE9BQU8sQ0FBQ3dGLEdBQVosRUFBaUI7QUFDZkgsTUFBQUEsUUFBUSxDQUFDRyxHQUFULEdBQWV4RixPQUFPLENBQUN3RixHQUF2QjtBQUNEOztBQUVELFFBQUlDLFFBQVEsR0FBRyxLQUFLdEYsSUFBTCxLQUFjLEdBQWQsR0FBb0IsVUFBcEIsR0FBaUMsU0FBaEQ7QUFFQSxTQUFLSyxVQUFMLENBQWdCa0YsSUFBaEIsQ0FDRTtBQUNFRixNQUFBQSxHQUFHLEVBQUVDLFFBQVEsR0FBRyxLQUFLN0YsSUFBaEIsR0FBdUJtQixJQUQ5QjtBQUVFc0UsTUFBQUEsUUFBUSxFQUFFQSxRQUZaO0FBR0VqRixNQUFBQSxPQUFPLEVBQUU7QUFDUHVGLFFBQUFBLGFBQWEsbUJBQVksS0FBSzFGLFdBQUwsQ0FBaUIyRSxXQUFqQixFQUFaO0FBRE47QUFIWCxLQURGLEVBUUVoRSxRQVJGO0FBVUQ7O0FBRUQ4RSxFQUFBQSxJQUFJLENBQUMzRSxJQUFELEVBQU9TLE1BQVAsRUFBZVosUUFBZixFQUF5QjRELE1BQXpCLEVBQWlDO0FBQ25DLFFBQUlRLEVBQUUsR0FBRyxFQUFUOztBQUNBLFFBQUksQ0FBQ1IsTUFBTCxFQUFhO0FBQ1hRLE1BQUFBLEVBQUUsQ0FBQyxTQUFELENBQUYsR0FBZ0IsS0FBSy9FLFdBQUwsQ0FBaUJ5RSxNQUFqQztBQUNBTSxNQUFBQSxFQUFFLENBQUMsWUFBRCxDQUFGLEdBQW1CLEtBQUsvRSxXQUFMLENBQWlCMEUsU0FBcEM7QUFDRDs7QUFFRCxRQUFJTyxRQUFRLEdBQUcsR0FBZjs7QUFDQSxRQUFJbkUsSUFBSSxDQUFDb0UsT0FBTCxDQUFhRCxRQUFiLE1BQTJCLENBQUMsQ0FBaEMsRUFBbUM7QUFDakNBLE1BQUFBLFFBQVEsR0FBRyxHQUFYO0FBQ0Q7O0FBRURuRSxJQUFBQSxJQUFJLEdBQUdBLElBQUksR0FBR21FLFFBQVAsR0FBa0IzRixXQUFXLENBQUNtRCxTQUFaLENBQXNCc0MsRUFBdEIsQ0FBekI7QUFFQSxTQUFLMUYsT0FBTCxDQUNFO0FBQ0V5QixNQUFBQSxJQUFJLEVBQUVBLElBRFI7QUFFRVcsTUFBQUEsSUFBSSxFQUFFbkMsV0FBVyxDQUFDbUQsU0FBWixDQUFzQmxCLE1BQXRCO0FBRlIsS0FERixFQUtFLE1BTEYsRUFNRVosUUFORjtBQVFEOztBQUVEZ0YsRUFBQUEsUUFBUSxDQUFDN0UsSUFBRCxFQUFPUyxNQUFQLEVBQWVaLFFBQWYsRUFBeUI0RCxNQUF6QixFQUFpQ0MsWUFBakMsRUFBK0M7QUFDckQsUUFBSU8sRUFBRSxHQUFHLEVBQVQ7O0FBQ0EsUUFBSSxDQUFDUixNQUFELElBQVcsQ0FBQ0MsWUFBaEIsRUFBOEI7QUFDNUJPLE1BQUFBLEVBQUUsQ0FBQyxTQUFELENBQUYsR0FBZ0IsS0FBSy9FLFdBQUwsQ0FBaUJ5RSxNQUFqQztBQUNBTSxNQUFBQSxFQUFFLENBQUMsWUFBRCxDQUFGLEdBQW1CLEtBQUsvRSxXQUFMLENBQWlCMEUsU0FBcEM7QUFDRDs7QUFFRCxRQUFJTyxRQUFRLEdBQUcsR0FBZjs7QUFDQSxRQUFJbkUsSUFBSSxDQUFDb0UsT0FBTCxDQUFhRCxRQUFiLE1BQTJCLENBQUMsQ0FBaEMsRUFBbUM7QUFDakNBLE1BQUFBLFFBQVEsR0FBRyxHQUFYO0FBQ0Q7O0FBRURuRSxJQUFBQSxJQUFJLEdBQUdBLElBQUksR0FBR21FLFFBQVAsR0FBa0IzRixXQUFXLENBQUNtRCxTQUFaLENBQXNCc0MsRUFBdEIsQ0FBekI7QUFFQSxRQUFJNUUsT0FBTyxHQUFHO0FBQ1osc0JBQWdCO0FBREosS0FBZDs7QUFHQSxRQUFJcUUsWUFBSixFQUFrQjtBQUNoQnJFLE1BQUFBLE9BQU8sQ0FBQyxlQUFELENBQVAsbUJBQW9DaUQsTUFBTSxDQUFDd0IsSUFBUCxDQUNsQyxLQUFLNUUsV0FBTCxDQUFpQnlFLE1BQWpCLEdBQTBCLEdBQTFCLEdBQWdDLEtBQUt6RSxXQUFMLENBQWlCMEUsU0FEZixFQUVsQzFDLFFBRmtDLENBRXpCLFFBRnlCLENBQXBDO0FBR0Q7O0FBRUQsU0FBSzNDLE9BQUwsQ0FDRTtBQUNFeUIsTUFBQUEsSUFBSSxFQUFFQSxJQURSO0FBRUVXLE1BQUFBLElBQUksRUFBRUcsSUFBSSxDQUFDYSxTQUFMLENBQWVsQixNQUFmLENBRlI7QUFHRXBCLE1BQUFBO0FBSEYsS0FERixFQU1FLE1BTkYsRUFPRVEsUUFQRjtBQVNEOztBQUVEaUYsRUFBQUEsa0JBQWtCLENBQUM5RSxJQUFELEVBQU9TLE1BQVAsRUFBZVosUUFBZixFQUF5QjRELE1BQXpCLEVBQWlDO0FBQ2pEaEQsSUFBQUEsTUFBTSxHQUFHQSxNQUFNLElBQUksRUFBbkI7O0FBQ0EsUUFBSSxDQUFDZ0QsTUFBTCxFQUFhO0FBQ1hoRCxNQUFBQSxNQUFNLENBQUMsU0FBRCxDQUFOLEdBQW9CLEtBQUt2QixXQUFMLENBQWlCeUUsTUFBckM7QUFDQWxELE1BQUFBLE1BQU0sQ0FBQyxZQUFELENBQU4sR0FBdUIsS0FBS3ZCLFdBQUwsQ0FBaUIwRSxTQUF4QztBQUNEOztBQUVENUQsSUFBQUEsSUFBSSxHQUFHQSxJQUFJLEdBQUcsR0FBUCxHQUFheEIsV0FBVyxDQUFDbUQsU0FBWixDQUFzQmxCLE1BQXRCLENBQXBCO0FBQ0EsU0FBS2xDLE9BQUwsQ0FDRTtBQUNFeUIsTUFBQUEsSUFBSSxFQUFFQTtBQURSLEtBREYsRUFJRSxNQUpGLEVBS0VILFFBTEY7QUFPRDs7QUF2Y2M7O2VBMGNGZCxVIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGh0dHBzID0gcmVxdWlyZShcImh0dHBzXCIpO1xudmFyIGh0dHAgPSByZXF1aXJlKFwiaHR0cFwiKTtcbnZhciByZXF1ZXN0ID0gcmVxdWlyZShcInJlcXVlc3RcIik7XG52YXIgcXVlcnlzdHJpbmcgPSByZXF1aXJlKFwicXVlcnktc3RyaW5nXCIpO1xudmFyIFVSTCA9IHJlcXVpcmUoXCJ1cmxcIikuVVJMO1xuXG5jb25zdCBpc1ZhbGlkVXJsID0gKHMpID0+IHtcbiAgaWYgKCFzIHx8IHMgPT09IG51bGwpIHJldHVybiBmYWxzZTtcblxuICB0cnkge1xuICAgIGlmIChzID09PSBcImFwaS5uZXhtby5jb21cIikgcmV0dXJuIHM7XG4gICAgbGV0IG8gPSBuZXcgVVJMKHMpO1xuICAgIHJldHVybiBvLmhvc3Q7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufTtcblxuY2xhc3MgSHR0cENsaWVudCB7XG4gIGNvbnN0cnVjdG9yKG9wdGlvbnMsIGNyZWRlbnRpYWxzKSB7XG4gICAgbGV0IGhvc3RPdmVycmlkZSA9IGlzVmFsaWRVcmwob3B0aW9ucy5ob3N0KTtcbiAgICB0aGlzLmNyZWRlbnRpYWxzID0gY3JlZGVudGlhbHM7XG4gICAgdGhpcy5ob3N0ID0gaG9zdE92ZXJyaWRlID8gaG9zdE92ZXJyaWRlIDogYHJlc3QubmV4bW8uY29tYDtcbiAgICB0aGlzLnBvcnQgPSBvcHRpb25zLnBvcnQgfHwgNDQzO1xuICAgIHRoaXMuaHR0cHMgPSBvcHRpb25zLmh0dHBzIHx8IGh0dHBzO1xuICAgIHRoaXMuaHR0cCA9IG9wdGlvbnMuaHR0cCB8fCBodHRwO1xuICAgIHRoaXMuaGVhZGVycyA9IHtcbiAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkXCIsXG4gICAgICBBY2NlcHQ6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgIH07XG4gICAgdGhpcy5sb2dnZXIgPSBvcHRpb25zLmxvZ2dlcjtcbiAgICB0aGlzLnRpbWVvdXQgPSBvcHRpb25zLnRpbWVvdXQ7XG4gICAgdGhpcy5yZXF1ZXN0TGliID0gcmVxdWVzdDtcblxuICAgIGlmIChvcHRpb25zLnVzZXJBZ2VudCkge1xuICAgICAgdGhpcy5oZWFkZXJzW1wiVXNlci1BZ2VudFwiXSA9IG9wdGlvbnMudXNlckFnZW50O1xuICAgIH1cbiAgfVxuXG4gIHJlcXVlc3QoXG4gICAgZW5kcG9pbnQsXG4gICAgbWV0aG9kLFxuICAgIGNhbGxiYWNrLFxuICAgIHNraXBKc29uUGFyc2luZyA9IGZhbHNlLFxuICAgIGN1c3RvbVJlc3BvbnNlUGFyc2VyXG4gICkge1xuICAgIGlmICh0eXBlb2YgbWV0aG9kID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIGNhbGxiYWNrID0gbWV0aG9kO1xuICAgICAgZW5kcG9pbnQubWV0aG9kID0gZW5kcG9pbnQubWV0aG9kIHx8IFwiR0VUXCI7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgbWV0aG9kICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBlbmRwb2ludC5tZXRob2QgPSBtZXRob2Q7XG4gICAgfVxuXG4gICAgdmFyIG9wdGlvbnMgPSB7XG4gICAgICBob3N0OiBlbmRwb2ludC5ob3N0ID8gZW5kcG9pbnQuaG9zdCA6IHRoaXMuaG9zdCxcbiAgICAgIHBvcnQ6IHRoaXMucG9ydCxcbiAgICAgIHBhdGg6IGVuZHBvaW50LnBhdGgsXG4gICAgICBtZXRob2Q6IGVuZHBvaW50Lm1ldGhvZCxcbiAgICAgIGhlYWRlcnM6IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuaGVhZGVycywgZW5kcG9pbnQuaGVhZGVycyksXG4gICAgfTtcblxuICAgIGlmICh0aGlzLnRpbWVvdXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgb3B0aW9ucy50aW1lb3V0ID0gdGhpcy50aW1lb3V0O1xuICAgIH1cblxuICAgIC8vIEFsbG93IGV4aXN0aW5nIGhlYWRlcnMgdG8gYmUgb3ZlcnJpZGRlblxuICAgIC8vIEFsbG93IG5ldyBoZWFkZXJzIHRvIGJlIGFkZGVkXG4gICAgaWYgKGVuZHBvaW50LmhlYWRlcnMpIHtcbiAgICAgIE9iamVjdC5rZXlzKGVuZHBvaW50LmhlYWRlcnMpLmZvckVhY2goZnVuY3Rpb24gKGtleSkge1xuICAgICAgICBvcHRpb25zLmhlYWRlcnNba2V5XSA9IGVuZHBvaW50LmhlYWRlcnNba2V5XTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIHRoZSBvdXRwdXQgaGVyZSBjYW4gcmV0dXJubiBvbmUgb2YgdHdvIG9wdGlvbnM6XG4gICAgLy8gLSBVc2luZyBgc2lnYCAmIGB0aW1lc3RhbXBgIGluIHRoZSBKU09OIGJvZHlcbiAgICAvLyAtIFVzaW5nIGBzaWdgICYgYHRpbWVzdGFtcGAgaW4gdGhlIHF1ZXJ5IHN0cmluZ1xuXG4gICAgaWYgKHRoaXMuY3JlZGVudGlhbHMuc2lnbmF0dXJlU2VjcmV0ICYmIHRoaXMuY3JlZGVudGlhbHMuc2lnbmF0dXJlTWV0aG9kKSB7XG4gICAgICAvLyB5b3UgbXVzdCBmaXJzdCBhZGQgYSB0aW1lc3RhbXBcbiAgICAgIGxldCBwYXJhbXM7XG4gICAgICBsZXQgc3BsaXRQYXRoO1xuICAgICAgbGV0IHBhdGg7XG5cbiAgICAgIC8vIGRldGVybWluZSBpZiB0aGUgcmVzcG9uc2Ugc2hvdWxkIGJlIHF1ZXJ5c3RyaW5nIG9yIEpTT04gYm9keVxuICAgICAgaWYgKCFlbmRwb2ludC5ib2R5KSB7XG4gICAgICAgIC8vIHRoaXMgYnJhbmNoIGlzIGZvciBxdWVyeSBzdHJpbmdcbiAgICAgICAgc3BsaXRQYXRoID0gb3B0aW9ucy5wYXRoLnNwbGl0KC9cXD8oLispLyk7XG4gICAgICAgIHBhdGggPSBzcGxpdFBhdGhbMF07XG5cbiAgICAgICAgcGFyYW1zID0gcXVlcnlzdHJpbmcucGFyc2Uoc3BsaXRQYXRoWzFdKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHRoaXMgc2VjdGlvbiBpcyBmb3IgSlNPTiBib2R5XG4gICAgICAgIHBhcmFtcyA9IEpTT04ucGFyc2UoZW5kcG9pbnQuYm9keSk7XG4gICAgICB9XG5cbiAgICAgIC8vIGFkZCB0aW1lc3RhbXAgaWYgbm90IGFscmVhZHkgcHJlc2VudFxuICAgICAgaWYgKCFwYXJhbXMudGltZXN0YW1wKSB7XG4gICAgICAgIHBhcmFtcy50aW1lc3RhbXAgPSAoKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC8gMTAwMCkgfCAwKS50b1N0cmluZygpO1xuICAgICAgfVxuXG4gICAgICAvLyBzdHJpcCBBUEkgU2VjcmV0XG4gICAgICBkZWxldGUgcGFyYW1zLmFwaV9zZWNyZXQ7XG5cbiAgICAgIGxldCBoYXNoID0gdGhpcy5jcmVkZW50aWFscy5nZW5lcmF0ZVNpZ25hdHVyZShwYXJhbXMpO1xuICAgICAgcGFyYW1zLnNpZyA9IGhhc2g7XG5cbiAgICAgIGlmICghZW5kcG9pbnQuYm9keSkge1xuICAgICAgICAvL3RoaXMgc2VjdGlvbiBpcyBmb3IgcXVlcnlzdHJpbmdcbiAgICAgICAgbGV0IHF1ZXJ5ID0gXCJcIjtcblxuICAgICAgICAvLyByZWJ1aWxkIHF1ZXJ5XG4gICAgICAgIE9iamVjdC5rZXlzKHBhcmFtcylcbiAgICAgICAgICAuc29ydCgpXG4gICAgICAgICAgLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICAgICAgcXVlcnkgKz0gXCImXCIgKyBrZXkgKyBcIj1cIiArIGVuY29kZVVSSShwYXJhbXNba2V5XSk7XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gcmVwbGFjZSB0aGUgZmlyc3QgJiB3aXRoID9cbiAgICAgICAgcXVlcnkgPSBxdWVyeS5yZXBsYWNlKC8mL2ksIFwiP1wiKTtcblxuICAgICAgICBvcHRpb25zLnBhdGggPSBgJHtwYXRofSR7cXVlcnl9YDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGVuZHBvaW50LmJvZHkgPSBKU09OLnN0cmluZ2lmeShwYXJhbXMpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMubG9nZ2VyLmluZm8oXCJSZXF1ZXN0OlwiLCBvcHRpb25zLCBcIlxcbkJvZHk6XCIsIGVuZHBvaW50LmJvZHkpO1xuXG4gICAgdmFyIHJlcXVlc3Q7XG5cbiAgICBpZiAob3B0aW9ucy5wb3J0ID09PSA0NDMpIHtcbiAgICAgIHJlcXVlc3QgPSB0aGlzLmh0dHBzLnJlcXVlc3Qob3B0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlcXVlc3QgPSB0aGlzLmh0dHAucmVxdWVzdChvcHRpb25zKTtcbiAgICB9XG5cbiAgICByZXF1ZXN0LmVuZChlbmRwb2ludC5ib2R5KTtcblxuICAgIC8vIEtlZXAgYW4gYXJyYXkgb2YgU3RyaW5nIG9yIEJ1ZmZlcnMsXG4gICAgLy8gZGVwZW5kaW5nIG9uIGNvbnRlbnQgdHlwZSAoYmluYXJ5IG9yIEpTT04pIG9mIHJlc3BvbnNlXG4gICAgdmFyIHJlc3BvbnNlRGF0YSA9IFtdO1xuXG4gICAgcmVxdWVzdC5vbihcInJlc3BvbnNlXCIsIChyZXNwb25zZSkgPT4ge1xuICAgICAgdmFyIGlzQmluYXJ5ID1cbiAgICAgICAgcmVzcG9uc2UuaGVhZGVyc1tcImNvbnRlbnQtdHlwZVwiXSA9PT0gXCJhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW1cIjtcbiAgICAgIGlmICghaXNCaW5hcnkpIHtcbiAgICAgICAgcmVzcG9uc2Uuc2V0RW5jb2RpbmcoXCJ1dGY4XCIpO1xuICAgICAgfVxuXG4gICAgICByZXNwb25zZS5vbihcImRhdGFcIiwgKGNodW5rKSA9PiB7XG4gICAgICAgIHJlc3BvbnNlRGF0YS5wdXNoKGNodW5rKTtcbiAgICAgIH0pO1xuXG4gICAgICByZXNwb25zZS5vbihcImVuZFwiLCAoKSA9PiB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmluZm8oXCJyZXNwb25zZSBlbmRlZDpcIiwgcmVzcG9uc2Uuc3RhdHVzQ29kZSk7XG4gICAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICAgIGlmIChpc0JpbmFyeSkge1xuICAgICAgICAgICAgcmVzcG9uc2VEYXRhID0gQnVmZmVyLmNvbmNhdChyZXNwb25zZURhdGEpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHRoaXMuX19wYXJzZVJlc3BvbnNlKFxuICAgICAgICAgICAgcmVzcG9uc2UsXG4gICAgICAgICAgICByZXNwb25zZURhdGEsXG4gICAgICAgICAgICBlbmRwb2ludC5tZXRob2QsXG4gICAgICAgICAgICBjYWxsYmFjayxcbiAgICAgICAgICAgIHNraXBKc29uUGFyc2luZyxcbiAgICAgICAgICAgIGN1c3RvbVJlc3BvbnNlUGFyc2VyXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXNwb25zZS5vbihcImNsb3NlXCIsIChlKSA9PiB7XG4gICAgICAgIGlmIChlKSB7XG4gICAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICAgICBcInByb2JsZW0gd2l0aCBBUEkgcmVxdWVzdCBkZXRhaWxlZCBzdGFja3RyYWNlIGJlbG93IFwiXG4gICAgICAgICAgKTtcbiAgICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihlKTtcbiAgICAgICAgICBjYWxsYmFjayhlKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmVxdWVzdC5vbihcImVycm9yXCIsIChlKSA9PiB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcInByb2JsZW0gd2l0aCBBUEkgcmVxdWVzdCBkZXRhaWxlZCBzdGFja3RyYWNlIGJlbG93IFwiKTtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGUpO1xuICAgICAgY2FsbGJhY2soZSk7XG4gICAgfSk7XG4gIH1cblxuICBfX3BhcnNlUmVzcG9uc2UoXG4gICAgaHR0cFJlc3BvbnNlLFxuICAgIGRhdGEsXG4gICAgbWV0aG9kLFxuICAgIGNhbGxiYWNrLFxuICAgIHNraXBKc29uUGFyc2luZyxcbiAgICBjdXN0b21SZXNwb25zZVBhcnNlclxuICApIHtcbiAgICBjb25zdCBpc0FycmF5T3JCdWZmZXIgPSBkYXRhIGluc3RhbmNlb2YgQXJyYXkgfHwgZGF0YSBpbnN0YW5jZW9mIEJ1ZmZlcjtcbiAgICBpZiAoIWlzQXJyYXlPckJ1ZmZlcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiZGF0YSBzaG91bGQgYmUgb2YgdHlwZSBBcnJheSBvciBCdWZmZXJcIik7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhdHVzID0gaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7XG4gICAgY29uc3QgaGVhZGVycyA9IGh0dHBSZXNwb25zZS5oZWFkZXJzO1xuXG4gICAgbGV0IHJlc3BvbnNlID0gbnVsbDtcbiAgICB2YXIgZXJyb3IgPSBudWxsO1xuXG4gICAgdHJ5IHtcbiAgICAgIGlmIChzdGF0dXMgPj0gNTAwKSB7XG4gICAgICAgIGVycm9yID0ge1xuICAgICAgICAgIG1lc3NhZ2U6IFwiU2VydmVyIEVycm9yXCIsXG4gICAgICAgICAgc3RhdHVzQ29kZTogc3RhdHVzLFxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgaHR0cFJlc3BvbnNlLmhlYWRlcnNbXCJjb250ZW50LXR5cGVcIl0gPT09IFwiYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtXCJcbiAgICAgICkge1xuICAgICAgICByZXNwb25zZSA9IGRhdGE7XG4gICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gNDI5KSB7XG4gICAgICAgIC8vIDQyOSBkb2VzIG5vdCByZXR1cm4gYSBwYXJzYWJsZSBib2R5XG4gICAgICAgIGlmICghaGVhZGVyc1tcInJldHJ5LWFmdGVyXCJdKSB7XG4gICAgICAgICAgLy8gcmV0cnkgYmFzZWQgb24gYWxsb3dlZCBwZXIgc2Vjb25kXG4gICAgICAgICAgY29uc3QgcmV0cnlBZnRlck1pbGxpcyA9IG1ldGhvZCA9PT0gXCJQT1NUXCIgPyAxMDAwIC8gMiA6IDEwMDAgLyA1O1xuICAgICAgICAgIGhlYWRlcnNbXCJyZXRyeS1hZnRlclwiXSA9IHJldHJ5QWZ0ZXJNaWxsaXM7XG4gICAgICAgIH1cbiAgICAgICAgZXJyb3IgPSB7XG4gICAgICAgICAgYm9keTogZGF0YS5qb2luKFwiXCIpLFxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIGlmIChzdGF0dXMgPT09IDIwNCkge1xuICAgICAgICByZXNwb25zZSA9IG51bGw7XG4gICAgICB9IGVsc2UgaWYgKHN0YXR1cyA+PSA0MDAgfHwgc3RhdHVzIDwgMjAwKSB7XG4gICAgICAgIGVycm9yID0ge1xuICAgICAgICAgIGJvZHk6IEpTT04ucGFyc2UoZGF0YS5qb2luKFwiXCIpKSxcbiAgICAgICAgICBoZWFkZXJzLFxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIGlmIChtZXRob2QgIT09IFwiREVMRVRFXCIpIHtcbiAgICAgICAgaWYgKCEhc2tpcEpzb25QYXJzaW5nKSB7XG4gICAgICAgICAgcmVzcG9uc2UgPSBkYXRhLmpvaW4oXCJcIik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzcG9uc2UgPSBKU09OLnBhcnNlKGRhdGEuam9pbihcIlwiKSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc3BvbnNlID0gZGF0YTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChwYXJzZUVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihwYXJzZUVycm9yKTtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBcImNvdWxkIG5vdCBjb252ZXJ0IEFQSSByZXNwb25zZSB0byBKU09OLCBhYm92ZSBlcnJvciBpcyBpZ25vcmVkIGFuZCByYXcgQVBJIHJlc3BvbnNlIGlzIHJldHVybmVkIHRvIGNsaWVudFwiXG4gICAgICApO1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXCJSYXcgRXJyb3IgbWVzc2FnZSBmcm9tIEFQSSBcIik7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgXCIke2RhdGF9XCJgKTtcblxuICAgICAgZXJyb3IgPSB7XG4gICAgICAgIHN0YXR1czogc3RhdHVzLFxuICAgICAgICBtZXNzYWdlOiBcIlRoZSBBUEkgcmVzcG9uc2UgY291bGQgbm90IGJlIHBhcnNlZC5cIixcbiAgICAgICAgYm9keTogZGF0YS5qb2luKFwiXCIpLFxuICAgICAgICBwYXJzZUVycm9yOiBwYXJzZUVycm9yLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgIGVycm9yLnN0YXR1c0NvZGUgPSBzdGF0dXM7XG4gICAgICBlcnJvci5oZWFkZXJzID0gaGVhZGVycztcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIGlmICh0eXBlb2YgY3VzdG9tUmVzcG9uc2VQYXJzZXIgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAvLyBkb24ndCB0cnkgdG8gcGFyc2UgdGhlIHJlc3BvbnNlIG9uIGVycm9yc1xuICAgICAgICBpZiAocmVzcG9uc2UpIHtcbiAgICAgICAgICByZXNwb25zZSA9IGN1c3RvbVJlc3BvbnNlUGFyc2VyKHJlc3BvbnNlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY2FsbGJhY2soZXJyb3IsIHJlc3BvbnNlKTtcbiAgICB9XG4gIH1cblxuICBfYWRkTGltaXRlZEFjY2Vzc01lc3NhZ2VUb0Vycm9ycyhjYWxsYmFjaywgbGltaXRlZEFjY2Vzc1N0YXR1cykge1xuICAgIHJldHVybiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7XG4gICAgICBpZiAoZXJyICYmIGVyci5zdGF0dXMgPT0gbGltaXRlZEFjY2Vzc1N0YXR1cykge1xuICAgICAgICBlcnIuX0lORk9fID1cbiAgICAgICAgICBcIlRoaXMgZW5kcG9pbnQgbWF5IG5lZWQgYWN0aXZhdGluZyBvbiB5b3VyIGFjY291bnQuIFBsZWFzZSBlbWFpbCBzdXBwb3J0QG5leG1vLmNvbSBmb3IgbW9yZSBpbmZvcm1hdGlvblwiO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gY2FsbGJhY2soZXJyLCBkYXRhKTtcbiAgICB9O1xuICB9XG5cbiAgZ2V0KHBhdGgsIHBhcmFtcywgY2FsbGJhY2ssIHVzZUp3dCA9IGZhbHNlLCB1c2VCYXNpY0F1dGggPSBmYWxzZSkge1xuICAgIGlmICghY2FsbGJhY2spIHtcbiAgICAgIGlmICh0eXBlb2YgcGFyYW1zID09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBjYWxsYmFjayA9IHBhcmFtcztcbiAgICAgICAgcGFyYW1zID0ge307XG4gICAgICB9XG4gICAgfVxuXG4gICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9O1xuICAgIGlmICghdXNlSnd0ICYmICF1c2VCYXNpY0F1dGgpIHtcbiAgICAgIHBhcmFtc1tcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaUtleTtcbiAgICAgIHBhcmFtc1tcImFwaV9zZWNyZXRcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaVNlY3JldDtcbiAgICB9XG5cbiAgICBwYXRoID0gcGF0aCArIFwiP1wiICsgcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHBhcmFtcyk7XG5cbiAgICBjb25zdCBoZWFkZXJzID0ge1xuICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgfTtcbiAgICBpZiAodXNlSnd0KSB7XG4gICAgICBoZWFkZXJzW1wiQXV0aG9yaXphdGlvblwiXSA9IGBCZWFyZXIgJHt0aGlzLmNyZWRlbnRpYWxzLmdlbmVyYXRlSnd0KCl9YDtcbiAgICB9XG4gICAgaWYgKHVzZUJhc2ljQXV0aCkge1xuICAgICAgaGVhZGVyc1tcIkF1dGhvcml6YXRpb25cIl0gPSBgQmFzaWMgJHtCdWZmZXIuZnJvbShcbiAgICAgICAgdGhpcy5jcmVkZW50aWFscy5hcGlLZXkgKyBcIjpcIiArIHRoaXMuY3JlZGVudGlhbHMuYXBpU2VjcmV0XG4gICAgICApLnRvU3RyaW5nKFwiYmFzZTY0XCIpfWA7XG4gICAgfVxuXG4gICAgdGhpcy5yZXF1ZXN0KFxuICAgICAge1xuICAgICAgICBwYXRoOiBwYXRoLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgfSxcbiAgICAgIFwiR0VUXCIsXG4gICAgICBjYWxsYmFja1xuICAgICk7XG4gIH1cblxuICBkZWxldGUocGF0aCwgY2FsbGJhY2ssIHVzZUp3dCwgdXNlQmFzaWNBdXRoKSB7XG4gICAgbGV0IHBhcmFtcyA9IHt9O1xuICAgIGlmICghdXNlSnd0ICYmICF1c2VCYXNpY0F1dGgpIHtcbiAgICAgIHBhcmFtc1tcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaUtleTtcbiAgICAgIHBhcmFtc1tcImFwaV9zZWNyZXRcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaVNlY3JldDtcbiAgICB9XG5cbiAgICBsZXQgaGVhZGVycyA9IHt9O1xuXG4gICAgaWYgKHVzZUJhc2ljQXV0aCkge1xuICAgICAgaGVhZGVyc1tcIkF1dGhvcml6YXRpb25cIl0gPSBgQmFzaWMgJHtCdWZmZXIuZnJvbShcbiAgICAgICAgdGhpcy5jcmVkZW50aWFscy5hcGlLZXkgKyBcIjpcIiArIHRoaXMuY3JlZGVudGlhbHMuYXBpU2VjcmV0XG4gICAgICApLnRvU3RyaW5nKFwiYmFzZTY0XCIpfWA7XG4gICAgfVxuICAgIHBhdGggPSBwYXRoICsgXCI/XCIgKyBxdWVyeXN0cmluZy5zdHJpbmdpZnkocGFyYW1zKTtcblxuICAgIHRoaXMucmVxdWVzdChcbiAgICAgIHtcbiAgICAgICAgcGF0aDogcGF0aCxcbiAgICAgICAgaGVhZGVycyxcbiAgICAgIH0sXG4gICAgICBcIkRFTEVURVwiLFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG5cbiAgcG9zdEZpbGUocGF0aCwgb3B0aW9ucywgY2FsbGJhY2ssIHVzZUp3dCkge1xuICAgIGxldCBxcyA9IHt9O1xuICAgIGlmICghdXNlSnd0KSB7XG4gICAgICBxc1tcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaUtleTtcbiAgICAgIHFzW1wiYXBpX3NlY3JldFwiXSA9IHRoaXMuY3JlZGVudGlhbHMuYXBpU2VjcmV0O1xuICAgIH1cblxuICAgIGlmIChPYmplY3Qua2V5cyhxcykubGVuZ3RoKSB7XG4gICAgICBsZXQgam9pbkNoYXIgPSBcIj9cIjtcbiAgICAgIGlmIChwYXRoLmluZGV4T2Yoam9pbkNoYXIpICE9PSAtMSkge1xuICAgICAgICBqb2luQ2hhciA9IFwiJlwiO1xuICAgICAgfVxuICAgICAgcGF0aCA9IHBhdGggKyBqb2luQ2hhciArIHF1ZXJ5c3RyaW5nLnN0cmluZ2lmeShxcyk7XG4gICAgfVxuXG4gICAgY29uc3QgZmlsZSA9IG9wdGlvbnMuZmlsZTtcbiAgICBkZWxldGUgb3B0aW9ucy5maWxlOyAvLyBXZSBkb24ndCBzZW5kIHRoaXMgYXMgbWV0YWRhdGFcblxuICAgIGNvbnN0IGZvcm1EYXRhID0ge307XG5cbiAgICBpZiAoZmlsZSkge1xuICAgICAgZm9ybURhdGFbXCJmaWxlZGF0YVwiXSA9IHtcbiAgICAgICAgdmFsdWU6IGZpbGUsXG4gICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICBmaWxlbmFtZTogb3B0aW9ucy5maWxlbmFtZSB8fCBudWxsLFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAob3B0aW9ucy5pbmZvKSB7XG4gICAgICBmb3JtRGF0YS5pbmZvID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5pbmZvKTtcbiAgICB9XG5cbiAgICBpZiAob3B0aW9ucy51cmwpIHtcbiAgICAgIGZvcm1EYXRhLnVybCA9IG9wdGlvbnMudXJsO1xuICAgIH1cblxuICAgIGxldCBwcm90b2NvbCA9IHRoaXMucG9ydCA9PT0gNDQzID8gXCJodHRwczovL1wiIDogXCJodHRwOi8vXCI7XG5cbiAgICB0aGlzLnJlcXVlc3RMaWIucG9zdChcbiAgICAgIHtcbiAgICAgICAgdXJsOiBwcm90b2NvbCArIHRoaXMuaG9zdCArIHBhdGgsXG4gICAgICAgIGZvcm1EYXRhOiBmb3JtRGF0YSxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLmNyZWRlbnRpYWxzLmdlbmVyYXRlSnd0KCl9YCxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBjYWxsYmFja1xuICAgICk7XG4gIH1cblxuICBwb3N0KHBhdGgsIHBhcmFtcywgY2FsbGJhY2ssIHVzZUp3dCkge1xuICAgIGxldCBxcyA9IHt9O1xuICAgIGlmICghdXNlSnd0KSB7XG4gICAgICBxc1tcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaUtleTtcbiAgICAgIHFzW1wiYXBpX3NlY3JldFwiXSA9IHRoaXMuY3JlZGVudGlhbHMuYXBpU2VjcmV0O1xuICAgIH1cblxuICAgIGxldCBqb2luQ2hhciA9IFwiP1wiO1xuICAgIGlmIChwYXRoLmluZGV4T2Yoam9pbkNoYXIpICE9PSAtMSkge1xuICAgICAgam9pbkNoYXIgPSBcIiZcIjtcbiAgICB9XG5cbiAgICBwYXRoID0gcGF0aCArIGpvaW5DaGFyICsgcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHFzKTtcblxuICAgIHRoaXMucmVxdWVzdChcbiAgICAgIHtcbiAgICAgICAgcGF0aDogcGF0aCxcbiAgICAgICAgYm9keTogcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHBhcmFtcyksXG4gICAgICB9LFxuICAgICAgXCJQT1NUXCIsXG4gICAgICBjYWxsYmFja1xuICAgICk7XG4gIH1cblxuICBwb3N0SnNvbihwYXRoLCBwYXJhbXMsIGNhbGxiYWNrLCB1c2VKd3QsIHVzZUJhc2ljQXV0aCkge1xuICAgIGxldCBxcyA9IHt9O1xuICAgIGlmICghdXNlSnd0ICYmICF1c2VCYXNpY0F1dGgpIHtcbiAgICAgIHFzW1wiYXBpX2tleVwiXSA9IHRoaXMuY3JlZGVudGlhbHMuYXBpS2V5O1xuICAgICAgcXNbXCJhcGlfc2VjcmV0XCJdID0gdGhpcy5jcmVkZW50aWFscy5hcGlTZWNyZXQ7XG4gICAgfVxuXG4gICAgbGV0IGpvaW5DaGFyID0gXCI/XCI7XG4gICAgaWYgKHBhdGguaW5kZXhPZihqb2luQ2hhcikgIT09IC0xKSB7XG4gICAgICBqb2luQ2hhciA9IFwiJlwiO1xuICAgIH1cblxuICAgIHBhdGggPSBwYXRoICsgam9pbkNoYXIgKyBxdWVyeXN0cmluZy5zdHJpbmdpZnkocXMpO1xuXG4gICAgbGV0IGhlYWRlcnMgPSB7XG4gICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICB9O1xuICAgIGlmICh1c2VCYXNpY0F1dGgpIHtcbiAgICAgIGhlYWRlcnNbXCJBdXRob3JpemF0aW9uXCJdID0gYEJhc2ljICR7QnVmZmVyLmZyb20oXG4gICAgICAgIHRoaXMuY3JlZGVudGlhbHMuYXBpS2V5ICsgXCI6XCIgKyB0aGlzLmNyZWRlbnRpYWxzLmFwaVNlY3JldFxuICAgICAgKS50b1N0cmluZyhcImJhc2U2NFwiKX1gO1xuICAgIH1cblxuICAgIHRoaXMucmVxdWVzdChcbiAgICAgIHtcbiAgICAgICAgcGF0aDogcGF0aCxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocGFyYW1zKSxcbiAgICAgICAgaGVhZGVycyxcbiAgICAgIH0sXG4gICAgICBcIlBPU1RcIixcbiAgICAgIGNhbGxiYWNrXG4gICAgKTtcbiAgfVxuXG4gIHBvc3RVc2VRdWVyeVN0cmluZyhwYXRoLCBwYXJhbXMsIGNhbGxiYWNrLCB1c2VKd3QpIHtcbiAgICBwYXJhbXMgPSBwYXJhbXMgfHwge307XG4gICAgaWYgKCF1c2VKd3QpIHtcbiAgICAgIHBhcmFtc1tcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaUtleTtcbiAgICAgIHBhcmFtc1tcImFwaV9zZWNyZXRcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaVNlY3JldDtcbiAgICB9XG5cbiAgICBwYXRoID0gcGF0aCArIFwiP1wiICsgcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHBhcmFtcyk7XG4gICAgdGhpcy5yZXF1ZXN0KFxuICAgICAge1xuICAgICAgICBwYXRoOiBwYXRoLFxuICAgICAgfSxcbiAgICAgIFwiUE9TVFwiLFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEh0dHBDbGllbnQ7XG4iXX0=