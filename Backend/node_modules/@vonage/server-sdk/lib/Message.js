"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Utils = _interopRequireDefault(require("./Utils"));

var _ShortCode = _interopRequireDefault(require("./ShortCode"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var querystring = require("querystring");

class Message {
  static get ERROR_MESSAGES() {
    return {
      sender: "Invalid from address",
      to: "Invalid to address",
      msg: "Invalid Text Message",
      body: "Invalid Body value in Binary Message",
      udh: "Invalid udh value in Binary Message",
      title: "Invalid title in WAP Push message",
      url: "Invalid url in WAP Push message"
    };
  }

  static get PATH() {
    return "/sms/json";
  }
  /**
   * @param {Credentials} credentials
   *    credentials to be used when interacting with the API.
   * @param {Object} options
   *    Addition SMS options.
   */


  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    this.creds = credentials;
    this.options = options;

    var _shortcode = new _ShortCode.default(this.creds, this.options);

    this.shortcodeAlert = _shortcode.shortcodeAlert.bind(_shortcode);
    this.shortcode2FA = _shortcode.shortcode2FA.bind(_shortcode);
    this.shortcodeMarketing = _shortcode.shortcodeMarketing.bind(_shortcode);
  }

  _checkToAndFrom(data, callback) {
    if (!data.from) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.sender));
    } else if (!data.to) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.to));
    } else {
      return;
    }
  } // _sendMessageCallback


  _sendMessage(data, callback) {
    this._checkToAndFrom(data, callback);

    this.options.logger.info("sending message from " + data.from + " to " + data.to + " with message " + data.text);
    var creds = {
      api_key: this.creds.apiKey,
      api_secret: this.creds.apiSecret
    };
    var body = Object.assign({}, creds, data);
    this.options.httpClient.request({
      host: this.options.restHost || "rest.nexmo.com",
      path: Message.PATH,
      body: JSON.stringify(body),
      headers: {
        "Content-Type": "application/json"
      }
    }, "POST", (err, apiResponse) => {
      if (!err && apiResponse.status && apiResponse.messages[0].status > 0) {
        _Utils.default.sendError(callback, new Error(apiResponse.messages[0]["error-text"]), apiResponse);
      } else {
        if (callback) callback(err, apiResponse);
      }
    });
  }
  /**
   * TODO: document
   */


  sendSms(sender, recipient, message, opts, callback) {
    if (!message) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.msg));
    } else {
      if (!callback) {
        callback = opts;
        opts = {};
      }

      opts["from"] = sender;
      opts["to"] = recipient;
      opts["text"] = message;

      this._sendMessage(opts, callback);
    }
  }
  /**
   * TODO: document
   */


  sendBinaryMessage(sender, recipient, body, udh, opts, callback) {
    if (!body) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.body));
    } else if (!udh) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.udh));
    } else {
      if (!callback) {
        callback = opts;
        opts = {};
      }

      opts["from"] = sender;
      opts["to"] = recipient;
      opts["type"] = "binary";
      opts["body"] = body;
      opts["udh"] = udh;

      this._sendMessage(opts, callback);
    }
  }
  /**
   * TODO: document
   */


  sendWapPushMessage(sender, recipient, title, url, validity, opts, callback) {
    if (!title) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.title));
    } else if (!url) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.url));
    } else {
      if (typeof validity === "function") {
        callback = validity;
        opts = {};
        validity = 86400000;
      }

      if (typeof opts === "function") {
        callback = opts;
        opts = {};
      }

      opts["from"] = sender;
      opts["to"] = recipient;
      opts["type"] = "wappush";
      opts["title"] = title;
      opts["validity"] = validity;
      opts["url"] = url;

      this._sendMessage(opts, callback);
    }
  }

  search(id, callback) {
    if (typeof id == "string") {
      return this.options.rest.get("/search/message", {
        id: id
      }, callback);
    } // Otherwise we expect an array


    return this.options.rest.get("/search/messages", {
      ids: id
    }, callback);
  }

  searchRejections(to, date, callback) {
    return this.options.rest.get("/search/rejections", {
      to,
      date
    }, callback);
  }

}

var _default = Message;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9NZXNzYWdlLmpzIl0sIm5hbWVzIjpbInF1ZXJ5c3RyaW5nIiwicmVxdWlyZSIsIk1lc3NhZ2UiLCJFUlJPUl9NRVNTQUdFUyIsInNlbmRlciIsInRvIiwibXNnIiwiYm9keSIsInVkaCIsInRpdGxlIiwidXJsIiwiUEFUSCIsImNvbnN0cnVjdG9yIiwiY3JlZGVudGlhbHMiLCJvcHRpb25zIiwiY3JlZHMiLCJfc2hvcnRjb2RlIiwiU2hvcnRDb2RlIiwic2hvcnRjb2RlQWxlcnQiLCJiaW5kIiwic2hvcnRjb2RlMkZBIiwic2hvcnRjb2RlTWFya2V0aW5nIiwiX2NoZWNrVG9BbmRGcm9tIiwiZGF0YSIsImNhbGxiYWNrIiwiZnJvbSIsIlV0aWxzIiwic2VuZEVycm9yIiwiRXJyb3IiLCJfc2VuZE1lc3NhZ2UiLCJsb2dnZXIiLCJpbmZvIiwidGV4dCIsImFwaV9rZXkiLCJhcGlLZXkiLCJhcGlfc2VjcmV0IiwiYXBpU2VjcmV0IiwiT2JqZWN0IiwiYXNzaWduIiwiaHR0cENsaWVudCIsInJlcXVlc3QiLCJob3N0IiwicmVzdEhvc3QiLCJwYXRoIiwiSlNPTiIsInN0cmluZ2lmeSIsImhlYWRlcnMiLCJlcnIiLCJhcGlSZXNwb25zZSIsInN0YXR1cyIsIm1lc3NhZ2VzIiwic2VuZFNtcyIsInJlY2lwaWVudCIsIm1lc3NhZ2UiLCJvcHRzIiwic2VuZEJpbmFyeU1lc3NhZ2UiLCJzZW5kV2FwUHVzaE1lc3NhZ2UiLCJ2YWxpZGl0eSIsInNlYXJjaCIsImlkIiwicmVzdCIsImdldCIsImlkcyIsInNlYXJjaFJlamVjdGlvbnMiLCJkYXRlIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUVBOztBQUVBOzs7O0FBRUEsSUFBSUEsV0FBVyxHQUFHQyxPQUFPLENBQUMsYUFBRCxDQUF6Qjs7QUFFQSxNQUFNQyxPQUFOLENBQWM7QUFDYSxhQUFkQyxjQUFjLEdBQUc7QUFDMUIsV0FBTztBQUNMQyxNQUFBQSxNQUFNLEVBQUUsc0JBREg7QUFFTEMsTUFB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LEtBQUtWLE9BQUwsQ0FBYThDLElBQWIsQ0FBa0JDLEdBQWxCLENBQ0wsa0JBREssRUFFTDtBQUNFQyxNQUFBQSxHQUFHLEVBQUVIO0FBRFAsS0FGSyxFQUtMbkMsUUFMSyxDQUFQO0FBT0Q7O0FBRUR1QyxFQUFBQSxnQkFBZ0IsQ0FBQzFELEVBQUQsRUFBSzJELElBQUwsRUFBV3hDLFFBQVgsRUFBcUI7QUFDbkMsV0FBTyxLQUFLVixPQUFMLENBQWE4QyxJQUFiLENBQWtCQyxHQUFsQixDQUNMLG9CQURLLEVBRUw7QUFDRXhELE1BQUFBLEVBREY7QUFFRTJELE1BQUFBO0FBRkYsS0FGSyxFQU1MeEMsUUFOSyxDQUFQO0FBUUQ7O0FBeExXOztlQTJMQ3RCLE8iLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IFV0aWxzIGZyb20gXCIuL1V0aWxzXCI7XG5cbmltcG9ydCBTaG9ydENvZGUgZnJvbSBcIi4vU2hvcnRDb2RlXCI7XG5cbnZhciBxdWVyeXN0cmluZyA9IHJlcXVpcmUoXCJxdWVyeXN0cmluZ1wiKTtcblxuY2xhc3MgTWVzc2FnZSB7XG4gIHN0YXRpYyBnZXQgRVJST1JfTUVTU0FHRVMoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNlbmRlcjogXCJJbnZhbGlkIGZyb20gYWRkcmVzc1wiLFxuICAgICAgdG86IFwiSW52YWxpZCB0byBhZGRyZXNzXCIsXG4gICAgICBtc2c6IFwiSW52YWxpZCBUZXh0IE1lc3NhZ2VcIixcbiAgICAgIGJvZHk6IFwiSW52YWxpZCBCb2R5IHZhbHVlIGluIEJpbmFyeSBNZXNzYWdlXCIsXG4gICAgICB1ZGg6IFwiSW52YWxpZCB1ZGggdmFsdWUgaW4gQmluYXJ5IE1lc3NhZ2VcIixcbiAgICAgIHRpdGxlOiBcIkludmFsaWQgdGl0bGUgaW4gV0FQIFB1c2ggbWVzc2FnZVwiLFxuICAgICAgdXJsOiBcIkludmFsaWQgdXJsIGluIFdBUCBQdXNoIG1lc3NhZ2VcIixcbiAgICB9O1xuICB9XG5cbiAgc3RhdGljIGdldCBQQVRIKCkge1xuICAgIHJldHVybiBcIi9zbXMvanNvblwiO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7Q3JlZGVudGlhbHN9IGNyZWRlbnRpYWxzXG4gICAqICAgIGNyZWRlbnRpYWxzIHRvIGJlIHVzZWQgd2hlbiBpbnRlcmFjdGluZyB3aXRoIHRoZSBBUEkuXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zXG4gICAqICAgIEFkZGl0aW9uIFNNUyBvcHRpb25zLlxuICAgKi9cbiAgY29uc3RydWN0b3IoY3JlZGVudGlhbHMsIG9wdGlvbnMgPSB7fSkge1xuICAgIHRoaXMuY3JlZHMgPSBjcmVkZW50aWFscztcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuXG4gICAgdmFyIF9zaG9ydGNvZGUgPSBuZXcgU2hvcnRDb2RlKHRoaXMuY3JlZHMsIHRoaXMub3B0aW9ucyk7XG5cbiAgICB0aGlzLnNob3J0Y29kZUFsZXJ0ID0gX3Nob3J0Y29kZS5zaG9ydGNvZGVBbGVydC5iaW5kKF9zaG9ydGNvZGUpO1xuICAgIHRoaXMuc2hvcnRjb2RlMkZBID0gX3Nob3J0Y29kZS5zaG9ydGNvZGUyRkEuYmluZChfc2hvcnRjb2RlKTtcbiAgICB0aGlzLnNob3J0Y29kZU1hcmtldGluZyA9IF9zaG9ydGNvZGUuc2hvcnRjb2RlTWFya2V0aW5nLmJpbmQoX3Nob3J0Y29kZSk7XG4gIH1cblxuICBfY2hlY2tUb0FuZEZyb20oZGF0YSwgY2FsbGJhY2spIHtcbiAgICBpZiAoIWRhdGEuZnJvbSkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTWVzc2FnZS5FUlJPUl9NRVNTQUdFUy5zZW5kZXIpKTtcbiAgICB9IGVsc2UgaWYgKCFkYXRhLnRvKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihNZXNzYWdlLkVSUk9SX01FU1NBR0VTLnRvKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gIH1cblxuICAvLyBfc2VuZE1lc3NhZ2VDYWxsYmFja1xuXG4gIF9zZW5kTWVzc2FnZShkYXRhLCBjYWxsYmFjaykge1xuICAgIHRoaXMuX2NoZWNrVG9BbmRGcm9tKGRhdGEsIGNhbGxiYWNrKTtcblxuICAgIHRoaXMub3B0aW9ucy5sb2dnZXIuaW5mbyhcbiAgICAgIFwic2VuZGluZyBtZXNzYWdlIGZyb20gXCIgK1xuICAgICAgICBkYXRhLmZyb20gK1xuICAgICAgICBcIiB0byBcIiArXG4gICAgICAgIGRhdGEudG8gK1xuICAgICAgICBcIiB3aXRoIG1lc3NhZ2UgXCIgK1xuICAgICAgICBkYXRhLnRleHRcbiAgICApO1xuXG4gICAgbGV0IGNyZWRzID0ge1xuICAgICAgYXBpX2tleTogdGhpcy5jcmVkcy5hcGlLZXksXG4gICAgICBhcGlfc2VjcmV0OiB0aGlzLmNyZWRzLmFwaVNlY3JldCxcbiAgICB9O1xuXG4gICAgbGV0IGJvZHkgPSBPYmplY3QuYXNzaWduKHt9LCBjcmVkcywgZGF0YSk7XG4gICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChcbiAgICAgIHtcbiAgICAgICAgaG9zdDogdGhpcy5vcHRpb25zLnJlc3RIb3N0IHx8IFwicmVzdC5uZXhtby5jb21cIixcbiAgICAgICAgcGF0aDogTWVzc2FnZS5QQVRILFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShib2R5KSxcbiAgICAgICAgaGVhZGVyczogeyBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIiB9LFxuICAgICAgfSxcbiAgICAgIFwiUE9TVFwiLFxuICAgICAgKGVyciwgYXBpUmVzcG9uc2UpID0+IHtcbiAgICAgICAgaWYgKCFlcnIgJiYgYXBpUmVzcG9uc2Uuc3RhdHVzICYmIGFwaVJlc3BvbnNlLm1lc3NhZ2VzWzBdLnN0YXR1cyA+IDApIHtcbiAgICAgICAgICBVdGlscy5zZW5kRXJyb3IoXG4gICAgICAgICAgICBjYWxsYmFjayxcbiAgICAgICAgICAgIG5ldyBFcnJvcihhcGlSZXNwb25zZS5tZXNzYWdlc1swXVtcImVycm9yLXRleHRcIl0pLFxuICAgICAgICAgICAgYXBpUmVzcG9uc2VcbiAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soZXJyLCBhcGlSZXNwb25zZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICBzZW5kU21zKHNlbmRlciwgcmVjaXBpZW50LCBtZXNzYWdlLCBvcHRzLCBjYWxsYmFjaykge1xuICAgIGlmICghbWVzc2FnZSkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTWVzc2FnZS5FUlJPUl9NRVNTQUdFUy5tc2cpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFjYWxsYmFjaykge1xuICAgICAgICBjYWxsYmFjayA9IG9wdHM7XG4gICAgICAgIG9wdHMgPSB7fTtcbiAgICAgIH1cbiAgICAgIG9wdHNbXCJmcm9tXCJdID0gc2VuZGVyO1xuICAgICAgb3B0c1tcInRvXCJdID0gcmVjaXBpZW50O1xuICAgICAgb3B0c1tcInRleHRcIl0gPSBtZXNzYWdlO1xuICAgICAgdGhpcy5fc2VuZE1lc3NhZ2Uob3B0cywgY2FsbGJhY2spO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgc2VuZEJpbmFyeU1lc3NhZ2Uoc2VuZGVyLCByZWNpcGllbnQsIGJvZHksIHVkaCwgb3B0cywgY2FsbGJhY2spIHtcbiAgICBpZiAoIWJvZHkpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMuYm9keSkpO1xuICAgIH0gZWxzZSBpZiAoIXVkaCkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTWVzc2FnZS5FUlJPUl9NRVNTQUdFUy51ZGgpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFjYWxsYmFjaykge1xuICAgICAgICBjYWxsYmFjayA9IG9wdHM7XG4gICAgICAgIG9wdHMgPSB7fTtcbiAgICAgIH1cbiAgICAgIG9wdHNbXCJmcm9tXCJdID0gc2VuZGVyO1xuICAgICAgb3B0c1tcInRvXCJdID0gcmVjaXBpZW50O1xuICAgICAgb3B0c1tcInR5cGVcIl0gPSBcImJpbmFyeVwiO1xuICAgICAgb3B0c1tcImJvZHlcIl0gPSBib2R5O1xuICAgICAgb3B0c1tcInVkaFwiXSA9IHVkaDtcbiAgICAgIHRoaXMuX3NlbmRNZXNzYWdlKG9wdHMsIGNhbGxiYWNrKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogZG9jdW1lbnRcbiAgICovXG4gIHNlbmRXYXBQdXNoTWVzc2FnZShzZW5kZXIsIHJlY2lwaWVudCwgdGl0bGUsIHVybCwgdmFsaWRpdHksIG9wdHMsIGNhbGxiYWNrKSB7XG4gICAgaWYgKCF0aXRsZSkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTWVzc2FnZS5FUlJPUl9NRVNTQUdFUy50aXRsZSkpO1xuICAgIH0gZWxzZSBpZiAoIXVybCkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTWVzc2FnZS5FUlJPUl9NRVNTQUdFUy51cmwpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHR5cGVvZiB2YWxpZGl0eSA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIGNhbGxiYWNrID0gdmFsaWRpdHk7XG4gICAgICAgIG9wdHMgPSB7fTtcbiAgICAgICAgdmFsaWRpdHkgPSA4NjQwMDAwMDtcbiAgICAgIH1cbiAgICAgIGlmICh0eXBlb2Ygb3B0cyA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIGNhbGxiYWNrID0gb3B0cztcbiAgICAgICAgb3B0cyA9IHt9O1xuICAgICAgfVxuICAgICAgb3B0c1tcImZyb21cIl0gPSBzZW5kZXI7XG4gICAgICBvcHRzW1widG9cIl0gPSByZWNpcGllbnQ7XG4gICAgICBvcHRzW1widHlwZVwiXSA9IFwid2FwcHVzaFwiO1xuICAgICAgb3B0c1tcInRpdGxlXCJdID0gdGl0bGU7XG4gICAgICBvcHRzW1widmFsaWRpdHlcIl0gPSB2YWxpZGl0eTtcbiAgICAgIG9wdHNbXCJ1cmxcIl0gPSB1cmw7XG4gICAgICB0aGlzLl9zZW5kTWVzc2FnZShvcHRzLCBjYWxsYmFjayk7XG4gICAgfVxuICB9XG5cbiAgc2VhcmNoKGlkLCBjYWxsYmFjaykge1xuICAgIGlmICh0eXBlb2YgaWQgPT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy5yZXN0LmdldChcbiAgICAgICAgXCIvc2VhcmNoL21lc3NhZ2VcIixcbiAgICAgICAge1xuICAgICAgICAgIGlkOiBpZCxcbiAgICAgICAgfSxcbiAgICAgICAgY2FsbGJhY2tcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gT3RoZXJ3aXNlIHdlIGV4cGVjdCBhbiBhcnJheVxuICAgIHJldHVybiB0aGlzLm9wdGlvbnMucmVzdC5nZXQoXG4gICAgICBcIi9zZWFyY2gvbWVzc2FnZXNcIixcbiAgICAgIHtcbiAgICAgICAgaWRzOiBpZCxcbiAgICAgIH0sXG4gICAgICBjYWxsYmFja1xuICAgICk7XG4gIH1cblxuICBzZWFyY2hSZWplY3Rpb25zKHRvLCBkYXRlLCBjYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLm9wdGlvbnMucmVzdC5nZXQoXG4gICAgICBcIi9zZWFyY2gvcmVqZWN0aW9uc1wiLFxuICAgICAge1xuICAgICAgICB0byxcbiAgICAgICAgZGF0ZSxcbiAgICAgIH0sXG4gICAgICBjYWxsYmFja1xuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgTWVzc2FnZTtcbiJdfQ==